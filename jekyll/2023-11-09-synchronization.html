<!DOCTYPE HTML>
<html lang="en" >
    <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="google-site-verification" content="MrJpPCJ8htzZlGpC1wo97QA1_XWns05Ez0LBsW3wj3I" /><title>OS | Synchronization (Unfinished) Â· Home</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Build Jekyll site with the GitBook style.
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="Benson Hsu"><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-splitter/splitter.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/colorful.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/assets/gitbook/images/favicon.ico" type="image/x-icon">




            <link rel="prev" href="/jekyll/2023-10-28-method_level_function_unit_testing.html" />
        

        
            <link rel="next" href="/jekyll/2023-11-23-based_on_clp_testcases.html" />
        
    </head>
    <body>
        <div class="book"><div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
            <li class="chapter" data-level="1.1" data-path="">
            
                <a href="/" onclick="pageScrollToTop(this)">
                    Home
                </a>
            </li>

            <li class="divider"></li>

            
                <!-- <p>pages</p> -->
                
                    

                    

                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2025-09-13-Big_Number_Multiplication.html">
                        
                            <a href="/jekyll/2025-09-13-Big_Number_Multiplication.html" onclick="pageScrollToTop(this)">
                                Algorithm | Big Number Multiplication
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2025-09-12-Binary_Search_Tricks_and_Hacks.html">
                        
                            <a href="/jekyll/2025-09-12-Binary_Search_Tricks_and_Hacks.html" onclick="pageScrollToTop(this)">
                                Algorithm | Binary Search Tricks and Hacks
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2024-10-17-KLEE_symbolic_execution.html">
                        
                            <a href="/jekyll/2024-10-17-KLEE_symbolic_execution.html" onclick="pageScrollToTop(this)">
                                Paper | KLEE: Introducing Symbolic Execution
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2024-07-28-parallel_and_distributed_systems_introduction.html">
                        
                            <a href="/jekyll/2024-07-28-parallel_and_distributed_systems_introduction.html" onclick="pageScrollToTop(this)">
                                PDS | Introduction of Parallel and Distributed Systems
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-06-21-competitive_paging_algorithm.html">
                        
                            <a href="/jekylls/2024-06-21-competitive_paging_algorithm.html" onclick="pageScrollToTop(this)">
                                Algorithm | Competitive Paging Algorithm
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-06-09-arch_user_repository.html">
                        
                            <a href="/jekylls/2024-06-09-arch_user_repository.html" onclick="pageScrollToTop(this)">
                                Note | Arch User Repository
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-04-09-hirschbergs_algorithm.html">
                        
                            <a href="/jekylls/2024-04-09-hirschbergs_algorithm.html" onclick="pageScrollToTop(this)">
                                Algorithm | Hirschberg&#39;s Algorithm
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-03-08-ANTLR_guide.html">
                        
                            <a href="/jekylls/2024-03-08-ANTLR_guide.html" onclick="pageScrollToTop(this)">
                                Compiler | ANTLR Guide
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-03-06-arch_linux_installation.html">
                        
                            <a href="/jekylls/2024-03-06-arch_linux_installation.html" onclick="pageScrollToTop(this)">
                                Note | Arch Linux Installation
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-03-01-maven_multi_module_project.html">
                        
                            <a href="/jekylls/2024-03-01-maven_multi_module_project.html" onclick="pageScrollToTop(this)">
                                Note | Apache Maven Multi-Module Project Guide
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2024-02-03-storage_and_file_system.html">
                        
                            <a href="/jekyll/2024-02-03-storage_and_file_system.html" onclick="pageScrollToTop(this)">
                                OS | Storage and File System
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-01-05-debian_btrfs.html">
                        
                            <a href="/jekylls/2024-01-05-debian_btrfs.html" onclick="pageScrollToTop(this)">
                                Note | Using btrfs on Debian
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2023-12-26-code_generation.html">
                        
                            <a href="/jekylls/2023-12-26-code_generation.html" onclick="pageScrollToTop(this)">
                                Compiler | Code Generation (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-12-23-virtual_memory.html">
                        
                            <a href="/jekyll/2023-12-23-virtual_memory.html" onclick="pageScrollToTop(this)">
                                OS | Virtual Memory
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-12-20-system_testing.html">
                        
                            <a href="/jekyll/2023-12-20-system_testing.html" onclick="pageScrollToTop(this)">
                                Testing | System Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-12-12-mutation_testing.html">
                        
                            <a href="/jekyll/2023-12-12-mutation_testing.html" onclick="pageScrollToTop(this)">
                                Testing | Mutation Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-12-10-main_memory.html">
                        
                            <a href="/jekyll/2023-12-10-main_memory.html" onclick="pageScrollToTop(this)">
                                OS | Main Memory
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-12-09-class_level_testing.html">
                        
                            <a href="/jekyll/2023-12-09-class_level_testing.html" onclick="pageScrollToTop(this)">
                                Testing | Class-Level Unit Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2023-11-29-semantic_analysis.html">
                        
                            <a href="/jekylls/2023-11-29-semantic_analysis.html" onclick="pageScrollToTop(this)">
                                Compiler | Semantic Analysis Notes
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-11-28-test_coverage_criteria.html">
                        
                            <a href="/jekyll/2023-11-28-test_coverage_criteria.html" onclick="pageScrollToTop(this)">
                                Note | Test Coverage Criteria
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-11-25-method_level_structural_unit_testing.html">
                        
                            <a href="/jekyll/2023-11-25-method_level_structural_unit_testing.html" onclick="pageScrollToTop(this)">
                                Testing | Method-Level Structural Unit Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-11-24-deadlock.html">
                        
                            <a href="/jekyll/2023-11-24-deadlock.html" onclick="pageScrollToTop(this)">
                                OS | Deadlock
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-11-23-based_on_clp_testcases.html">
                        
                            <a href="/jekyll/2023-11-23-based_on_clp_testcases.html" onclick="pageScrollToTop(this)">
                                Testing | Based on CLP Testcases
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/jekyll/2023-11-09-synchronization.html">
                        
                            <a href="/jekyll/2023-11-09-synchronization.html" onclick="pageScrollToTop(this)">
                                OS | Synchronization (Unfinished)
                            </a>
                            
                                
                                    <ul><li><a href="#critical-section" onclick="mobilePageScrollToAnchor(this)" >Critical Section</a></li><li><a href="#semaphore--mutex" onclick="mobilePageScrollToAnchor(this)" >Semaphore &amp; Mutex</a></li><li><a href="#use-semaphore-to-solve-common-problems" onclick="mobilePageScrollToAnchor(this)" >Use Semaphore to Solve Common Problems</a></li><li><a href="#atomic-operation" onclick="mobilePageScrollToAnchor(this)" >Atomic Operation</a></li><li><a href="#spinlock" onclick="mobilePageScrollToAnchor(this)" >Spinlock</a></li></ul>

                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-28-method_level_function_unit_testing.html">
                        
                            <a href="/jekyll/2023-10-28-method_level_function_unit_testing.html" onclick="pageScrollToTop(this)">
                                Testing | Method-Level Functional Unit Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2023-10-26-syntax_analysis.html">
                        
                            <a href="/jekylls/2023-10-26-syntax_analysis.html" onclick="pageScrollToTop(this)">
                                Compiler | Syntax Analysis Notes
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-19-cpu_scheduler.html">
                        
                            <a href="/jekyll/2023-10-19-cpu_scheduler.html" onclick="pageScrollToTop(this)">
                                OS | CPU Scheduler
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-18-process_thread.html">
                        
                            <a href="/jekyll/2023-10-18-process_thread.html" onclick="pageScrollToTop(this)">
                                OS | Process and Thread
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-17-container_of.html">
                        
                            <a href="/jekyll/2023-10-17-container_of.html" onclick="pageScrollToTop(this)">
                                Note | Linux Kernel Macro container_of &amp; offsetof
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-10-test_case_generation.html">
                        
                            <a href="/jekyll/2023-10-10-test_case_generation.html" onclick="pageScrollToTop(this)">
                                Testing | Test Case Generation
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-09-operating_system_structure.html">
                        
                            <a href="/jekyll/2023-10-09-operating_system_structure.html" onclick="pageScrollToTop(this)">
                                OS | Operating System Structure
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-23-software_testing_introduction.html">
                        
                            <a href="/jekyll/2023-09-23-software_testing_introduction.html" onclick="pageScrollToTop(this)">
                                Testing | Software Testing Introduction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2023-09-21-lexical_analysis.html">
                        
                            <a href="/jekylls/2023-09-21-lexical_analysis.html" onclick="pageScrollToTop(this)">
                                Compiler | Lexical Analysis Notes
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-20-compiler_introduction.html">
                        
                            <a href="/jekyll/2023-09-20-compiler_introduction.html" onclick="pageScrollToTop(this)">
                                Compiler | Compilers Introduction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-12-operating_system_introduction.html">
                        
                            <a href="/jekyll/2023-09-12-operating_system_introduction.html" onclick="pageScrollToTop(this)">
                                OS | Operating System Introduction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-07-test_case_generation_based_on_constraint_logic_graph.html">
                        
                            <a href="/jekyll/2023-09-07-test_case_generation_based_on_constraint_logic_graph.html" onclick="pageScrollToTop(this)">
                                Paper | Test Case Generation Based on Constraint Logic Graph
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-07-Introduction_OCL.html">
                        
                            <a href="/jekyll/2023-09-07-Introduction_OCL.html" onclick="pageScrollToTop(this)">
                                Note | Object Constraint Language Concepts (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-08-06-gdb_introduction.html">
                        
                            <a href="/jekyll/2023-08-06-gdb_introduction.html" onclick="pageScrollToTop(this)">
                                Note | GNU Debugger Quick Notes
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-08-05-linux_kernel_complie.html">
                        
                            <a href="/jekyll/2023-08-05-linux_kernel_complie.html" onclick="pageScrollToTop(this)">
                                OS | Linux Kernel Compilation
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-28-UML_structure_diagrams.html">
                        
                            <a href="/jekyll/2023-07-28-UML_structure_diagrams.html" onclick="pageScrollToTop(this)">
                                Note | UML Structure Diagrams Introduction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-28-UML_behavior_diagrams.html">
                        
                            <a href="/jekyll/2023-07-28-UML_behavior_diagrams.html" onclick="pageScrollToTop(this)">
                                Note | UML Behavior Diagrams Introduction (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-26-unified_modeling_language.html">
                        
                            <a href="/jekyll/2023-07-26-unified_modeling_language.html" onclick="pageScrollToTop(this)">
                                Note | Unified Modeling Language Concepts
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-22-property_based_testing_entropy_guided_backbox_REST_API-_fuzzer.html">
                        
                            <a href="/jekyll/2023-07-22-property_based_testing_entropy_guided_backbox_REST_API-_fuzzer.html" onclick="pageScrollToTop(this)">
                                Paper | BenFuzz: A Property Based Testing and Entropy Guided Blackbox REST API Fuzzer
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-19-MVVM_modeling_methodology_user_interface.html">
                        
                            <a href="/jekyll/2023-07-19-MVVM_modeling_methodology_user_interface.html" onclick="pageScrollToTop(this)">
                                Paper | A MVVM Modeling Methodology for Information Systems User Interface Design
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-18-software_arch_pattern.html">
                        
                            <a href="/jekyll/2023-07-18-software_arch_pattern.html" onclick="pageScrollToTop(this)">
                                Note | Architectural Patterns Compare MVP, MVC, MVVM
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-18-automated_gen_test_case_using_UML.html">
                        
                            <a href="/jekyll/2023-07-18-automated_gen_test_case_using_UML.html" onclick="pageScrollToTop(this)">
                                Paper | Automated-generating test case using UML statechart diagrams (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-06-23-Intergrated_environment_sdd.html">
                        
                            <a href="/jekyll/2023-06-23-Intergrated_environment_sdd.html" onclick="pageScrollToTop(this)">
                                Paper | An Integrated Environment for Specification Driven Development (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-05-28-characteristics_of_bdd.html">
                        
                            <a href="/jekyll/2023-05-28-characteristics_of_bdd.html" onclick="pageScrollToTop(this)">
                                Paper | A Study of the Characteristics of Behaviour Driven Development
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-05-20-analysis_mutation_testing.html">
                        
                            <a href="/jekyll/2023-05-20-analysis_mutation_testing.html" onclick="pageScrollToTop(this)">
                                Paper | An Analysis and Survey of the Development of Mutation Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-04-21-tdd_concepts.html">
                        
                            <a href="/jekyll/2023-04-21-tdd_concepts.html" onclick="pageScrollToTop(this)">
                                Paper | Test-driven development concepts, taxonomy, and future direction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-04-18-applying_isoiec25010.html">
                        
                            <a href="/jekyll/2023-04-18-applying_isoiec25010.html" onclick="pageScrollToTop(this)">
                                Paper | Applying the ISO/IEC 25010 Quality Models to Software Product
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-04-13-software_standard.html">
                        
                            <a href="/jekyll/2023-04-13-software_standard.html" onclick="pageScrollToTop(this)">
                                Note | Standard - ISO/IEC
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-02-04-algorithm_kmp.html">
                        
                            <a href="/jekyll/2023-02-04-algorithm_kmp.html" onclick="pageScrollToTop(this)">
                                Leetcode | Algorithm - KMP
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-01-12-gomoku_ai.html">
                        
                            <a href="/jekyll/2023-01-12-gomoku_ai.html" onclick="pageScrollToTop(this)">
                                Note | Gomoku AI - Game Tree
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2022-11-24-git_commit.html">
                        
                            <a href="/jekyll/2022-11-24-git_commit.html" onclick="pageScrollToTop(this)">
                                Note | Commit Message Format
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2022-11-08-ai_csp.html">
                        
                            <a href="/jekyll/2022-11-08-ai_csp.html" onclick="pageScrollToTop(this)">
                                Note | Constraint Satisfaction Problem
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2022-11-07-network_urat.html">
                        
                            <a href="/jekyll/2022-11-07-network_urat.html" onclick="pageScrollToTop(this)">
                                Note | Basic UART Concept
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2022-11-05-docker_jekyll.html">
                        
                            <a href="/jekyll/2022-11-05-docker_jekyll.html" onclick="pageScrollToTop(this)">
                                Note | Docker Build Github Pages
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/1970-01-01-virtual_machine_tool.html">
                        
                            <a href="/jekyll/1970-01-01-virtual_machine_tool.html" onclick="pageScrollToTop(this)">
                                Tool | Virtual Machine
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/1970-01-01-linux_config.html">
                        
                            <a href="/jekyll/1970-01-01-linux_config.html" onclick="pageScrollToTop(this)">
                                Tool | Linux Config
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/1970-01-01-leetcode_guide.html">
                        
                            <a href="/jekyll/1970-01-01-leetcode_guide.html" onclick="pageScrollToTop(this)">
                                Leetcode | Master Guide
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/1970-01-01-editor_envirmnment.html">
                        
                            <a href="/jekyll/1970-01-01-editor_envirmnment.html" onclick="pageScrollToTop(this)">
                                Tool | Edirot Guide
                            </a>
                            
                                
                            
                        </li>
                    

                    
                        <li class="divider"></li>
                    
                
            
        </ul>
    </nav>
</div>
<div class="book-body">
                <div class="book-header" role="navigation">
                    <!-- Title -->
                    <h1>
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        
                            <a href="." >OS | Synchronization (Unfinished)</a>
                        
                    </h1>
                </div>

                <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div class="normal">
            
            
            <section class="normal">November 09, 2023 </section>
            
        </div>
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    
                        <h1 id="/jekyll/synchronization">OS | Synchronization (Unfinished)</h1>
                    

                    <blockquote class="block-tip">
  <p>Operating System: Design and Implementation course notes from CCU, lecturer Shiwu-Lo.</p>
</blockquote>

<p>éåç« ç¯ä¸»è¦è¬çæ¯ Linux ä¸­å¦ææå¤å Task åæå­åè¨æ¶é«ï¼è¦æéº¼å»èç Synchronization çåé¡ã</p>

<ul>
  <li>å¤å Task å¦æåæå­å Memory æç¼çå½¼æ­¤è¤å¯«çåé¡
    <ul>
      <li>åæ Peripheral devices å¨ MMIO ä¸­ä¹æ¯ä¸å¡ Memory</li>
    </ul>
  </li>
  <li>è¦ä¿è­· Memory æç´è¦ºçæ³æ³æ¯ä¸è¦è®æå­ååä¸ä»½ Memory ç Task åæå·è¡
    <ul>
      <li>è¨­è¨ Critical Sectionï¼é¿å Task åæå·è¡</li>
      <li>Critical Section éå¿é æ¯ææçï¼å¬å¹³ç</li>
    </ul>
  </li>
  <li>å·æåç¼æ§çæ¹æ³ Petersonâs solution
    <ul>
      <li>åè¨­ read, write æ¯ atomic operation</li>
      <li>è­æ Petersonâs solution æ»¿è¶³ Critical Section ä¸åæ¢ä»¶</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>Critical Section ä¸åæ¢ä»¶: Mutual Exclusion, Progress, Bounded Waiting</p>
</blockquote>

<ul>
  <li>C11 å¯¦ç¾ Petersonâs solution</li>
  <li>æé¸åé©çä¿è­·æ©å¶
    <ul>
      <li>Mutex( /semaphore) = spinlock + sleep + wakeup</li>
      <li>é æç­å¾çæéå¾ç­ï¼ä½¿ç¨ spinlockï¼ä¾å¦: (Petersonâs solution)</li>
      <li>éè¦ç­å¾ä¸æ®µæéï¼ä½¿ç¨ mutex æ semaphore</li>
      <li>ä¸è¿°ç sleep è wakeup å¨ Linux ä¸­ç± system call <code class="language-plaintext highlighter-rouge">futex</code> å¯¦ç¾</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>spinlock è petersonâs solution é½é¡ä¼¼æ¼ä½¿ç¨ while loop ä¾å busy waiting</p>
</blockquote>

<ul>
  <li>å¸¸è¦çåé¡å½¢å¼</li>
  <li>Producer-Consumer Problem(çç¢èèæ¶è²»èåé¡)ï¼ä¾å¦: é©åç¨å¼èå¨éè¨­åçæºé</li>
  <li>Dining Philosophers Problem(å²å­¸å®¶å°±é¤åé¡)ï¼ä¾å¦: å¤å Task ä¹éçè³æºäº¤æ</li>
  <li>Reader-Writer Problem(è®èèå¯«èåé¡)ï¼ä¾å¦: åªæé±è®æªæ¡èä¸ä¿®æ¹æªæ¡ç Task</li>
  <li>Multi-Process åæå­åæï¼è¦ä¾ç§åªå Process çæé
    <ul>
      <li>æèå¦ä½ä¿è­åæ£å¼ç³»çµ±ä¹éä¹è½ä¿è­å­åçæ­£ç¢ºæ§(çæ¬æ¦å¿µ)</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>æå¾è¨è«ä¸äºæ·±å¥çåé¡</p>
</blockquote>

<ul>
  <li>å¾ç¡¬é«çè§åº¦ä¾ç atomic operation çå¯¦ç¾
    <ul>
      <li>äºè§£è»é«ä½¿ç¨ç atomic operation çä»£å¹</li>
    </ul>
  </li>
  <li>ä»¥ Linux kernel çºä¾èªªææç¨æå·§
    <ul>
      <li>å¤ç¨®ç spinlock(C11 å¯¦ç¾)ï¼semaphore(ä»¥é©åç¨å¼çºä¾)</li>
    </ul>
  </li>
  <li>æ´æ·±å¥çè¨è« memory order
    <ul>
      <li>Atomic å¨å¤èçå¨ä¸è¦åå°å¤å°çä¿è­</li>
    </ul>
  </li>
</ul>

<h5 id="51-multi-process-processing-one-data-at-the-same-time">5.1 Multi-Process processing one data at the same time</h5>

<p>éè£¡ç¨ä¸åç°¡å®çä¾å­ä¾èªªæåæèçä¸ç­è³ææç¢ççåé¡ï¼å¯ä»¥çå°è¼¸åºçµæä¸¦ä¸æ¯æåé æçï¼éæ¯å çºå©å thread åæå­å global è®æ¸ï¼é æå½¼æ­¤è¤å¯«çåé¡ã</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="n">global</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">1000000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">global</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pthread_t</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">;</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id1</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="kr">thread</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id2</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="kr">thread</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span><span class="n">pthread_join</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"1000000000+1000000000 = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">global</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// 1000000000+1000000000 = 1037054916</span>
</code></pre></div></div>

<p>ä½¿ç¨ <code class="language-plaintext highlighter-rouge">gcc -o exam1.exe exam1.c -g -</code> ä¹å¾ä½¿ç¨ gdb ä¾æ¥çç¨å¼ç¢¼ï¼ä½¿ç¨ <code class="language-plaintext highlighter-rouge">disassemble \m thread</code> ä¾åçµè­¯è§å¯åé¡å¨åªï¼
<code class="language-plaintext highlighter-rouge">\m</code> ä»£è¡¨æ c è· assembly code ä¸èµ·é¡¯ç¤ºã</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb ./exam1.exe 
<span class="o">(</span>gdb<span class="o">)</span> disassemble /m thread 
Dump of assembler code <span class="k">for function </span>thread:
4       void thread<span class="o">(</span>void<span class="o">)</span> <span class="o">{</span>
   0x0000000000001159 &lt;+0&gt;:     push   %rbp
   0x000000000000115a &lt;+1&gt;:     mov    %rsp,%rbp

5           <span class="k">for</span> <span class="o">(</span>int <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;1000000000<span class="p">;</span> i++<span class="o">)</span>
   0x000000000000115d &lt;+4&gt;:     movl   <span class="nv">$0x0</span>,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
   0x0000000000001164 &lt;+11&gt;:    jmp    0x1179 &lt;thread+32&gt;
   0x0000000000001175 &lt;+28&gt;:    addl   <span class="nv">$0x1</span>,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
   0x0000000000001179 &lt;+32&gt;:    cmpl   <span class="nv">$0x3b9ac9ff</span>,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
   0x0000000000001180 &lt;+39&gt;:    jle    0x1166 &lt;thread+13&gt;

6               global+<span class="o">=</span>1<span class="p">;</span>
   0x0000000000001166 &lt;+13&gt;:    mov    0x2ec0<span class="o">(</span>%rip<span class="o">)</span>,%eax        <span class="c"># 0x402c &lt;global&gt;</span>
   0x000000000000116c &lt;+19&gt;:    add    <span class="nv">$0x1</span>,%eax
   0x000000000000116f &lt;+22&gt;:    mov    %eax,0x2eb7<span class="o">(</span>%rip<span class="o">)</span>        <span class="c"># 0x402c &lt;global&gt;</span>

7       <span class="o">}</span>
   0x0000000000001182 &lt;+41&gt;:    nop
   0x0000000000001183 &lt;+42&gt;:    nop
   0x0000000000001184 &lt;+43&gt;:    pop    %rbp
   0x0000000000001185 &lt;+44&gt;:    ret

End of assembler dump.
</code></pre></div></div>

<p>åè¨­ global çåå§å¼çº 0ï¼å¨éåç¨å¼ä¸­æå¯è½æä¾ç§éæ¨£å·è¡ï¼CPU1 åå®å æ³å¾å¯«å¥ %ripï¼CPU2 ä¹åå®å æ³å¾å¯«å¥ %ripï¼éæ¨£å°±æé æå½¼æ­¤è¤å¯«çåé¡ã</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU1                            CPU2
1.  mov    0x2ec0<span class="o">(</span>%rip<span class="o">)</span>,%eax    1.
2.                              2.  mov    0x2ec0<span class="o">(</span>%rip<span class="o">)</span>,%eax
3.  add    <span class="nv">$0x1</span>,%eax            3.
4.  mov    %eax,0x2eb7<span class="o">(</span>%rip<span class="o">)</span>    4.
5.                              5.  add    <span class="nv">$0x1</span>,%eax
6.                              6.  mov    %eax,0x2eb7<span class="o">(</span>%rip<span class="o">)</span>
</code></pre></div></div>

<p>Atomicity çææå°±æ¯ç¶æåå¨å°ä¸å Data struct åæä½æï¼è¦ä¿è­æ´å struct æ¯ä¸æ¬¡æ§çæ´æ°ï¼éè£¡ç global variable æ¯ä¸åéå¸¸ç°¡å®çä¾å­ï¼ä½æ¯å¨å¯¦éçç¨å¼ä¸­å¯è½ææå¾è¤éç Data structï¼
å æ­¤è¦ä¿è­æ´å struct æ¯ä¸æ¬¡æ§çæ´æ°æ¯éå¸¸å°é£çã</p>

<ul>
  <li><strong>Definition correct solution</strong>
    <ul>
      <li>ä¸åæ­£ç¢ºç Multi-thread program æè©²è¦è·å¶å°æç Single-thread ç program æç¸åçè¡çº</li>
    </ul>
  </li>
</ul>

<h3 id="critical-section">Critical Section</h3>

<p><a href="./2023-11-09-synchronization.html#52-race-condition-probkem">5.2 Race condition problem</a><br />
<a href="./2023-11-09-synchronization.html#53-critical-section-three-conditions">5.3 Critical section three conditions</a><br />
<a href="./2023-11-09-synchronization.html#54-petersons-solution">5.4 Petersonâs solution</a><br />
<a href="./2023-11-09-synchronization.html#55-proof-petersons-sol-to-satisfy-critical-section-three-conditions">5.5 Proof petersonâs solution</a><br />
<a href="./2023-11-09-synchronization.html#56-c11-implementation">5.6 C11 implementation</a></p>

<p>Critical section å¶å¯¦å°±æ¯ä¸å¥åå®ï¼éå¥åå®ä½¿å¤å Task ä¹éå¯ä»¥äºç¸åä½</p>

<h5 id="52-race-condition-problem">5.2 Race condition problem</h5>

<p>Race condition(ç«¶ç­æ¢ä»¶)æ¯æè»é«ç³»çµ±çè¡çºï¼ç¶æä½æ¯åºæ¼ç¡æ³æ§å¶é åºçäºä»¶ææéï¼ç¶éäºäºä»¶æ²ä¾ç§ Programer æåçé åºç¼çæï¼å°±æåºç¾ bugã</p>

<ul>
  <li>Race condition çå¶ä¸­ä¸ç¨®è§£æ±ºæ¹å¼å°±æ¯
    <ul>
      <li>å¼å¥ Critical sectionï¼è® Task ä¹éäºç¸åä½</li>
      <li>æ³¨æ Critical section æä¿è­·çæ¯ç¨å¼ç¢¼</li>
    </ul>
  </li>
</ul>

<h5 id="53-critical-section-three-conditions">5.3 Critical section three conditions</h5>

<ol>
  <li>Mutual Exclusion(äºæ¥, åºæ¬æ¢ä»¶)
    <ul>
      <li>å¦ææä¸å Task å¨å·è¡ Critical sectionï¼é£éº¼å¶ä» Task å°±ä¸è½å·è¡ Critical section</li>
    </ul>
  </li>
  <li>Progress(é²å±, ææç)
    <ul>
      <li>å¦ææ²æ Task å¨å·è¡ Critical sectionï¼åªæä¸å¨ Remainder section ç Task æè½æ±ºå®èª°å¯ä»¥å·è¡ Critical sectionï¼ä¸¦ä¸ä¸è½ç¡éæçç­å¾</li>
    </ul>
  </li>
  <li>Bounded Waiting(æçç­å¾, å¬å¹³æ§)
    <ul>
      <li>å¦ææä¸å Task æ³è¦å·è¡ Critical sectionï¼é£éº¼å°±ä¸è½è®éå Task è¢«ç¡æéçç­å¾</li>
      <li>ä¾å¦: æ A, B å©å Taskï¼ä½æææ°¸é åªè® A å·è¡ Critical sectionï¼éæ¨£ B å°±æç¡éæçç­å¾</li>
    </ul>
  </li>
</ol>

<p><img src="/image/2023/11-09-synchronization/1.png" alt="" height="100%" width="100%" /></p>

<blockquote>
  <p>libc å¶å¯¦ä¸¦æ²ææ»¿è¶³ Bounded Waiting çæ¢ä»¶ï¼å¨æäºææ³ä¸æé æ starvation</p>
</blockquote>

<h5 id="54-petersons-solution">5.4 Petersonâs solution</h5>

<p><a href="https://en.wikipedia.org/wiki/Peterson%27s_algorithm">Petersonâs solution</a> æ¯ä¸åå®å¨è§£æ±º Race condition çç´è»é«æ¼ç®æ³</p>

<ul>
  <li>åè¨­åªæ P0, P1 å©å Task</li>
  <li>å°æ¼ç¡¬é«æä¸äºåºæ¬åè¨­
    <ul>
      <li><code class="language-plaintext highlighter-rouge">read</code>, <code class="language-plaintext highlighter-rouge">write</code> is atomic operation</li>
      <li>shard memory system
        <ul>
          <li>å çºåè¨­æ¯ shard memory systemï¼æä»¥ç¡æ³ç¨å¨ distributed system</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Petersonâs solution å¯ä»¥æ´å±å° N å Task</li>
</ul>

<ol>
  <li>åè¨­ P0, P1 å±äº«å©åè®æ¸
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">boolean</span> <span class="n">flag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">};</span> <span class="cm">/* Represents who wants to enter the Critical section */</span>
<span class="kt">int</span> <span class="n">turn</span><span class="p">;</span> <span class="cm">/* 0 means P0, 1 means P1 has priority when entering the critical area */</span>
</code></pre></div>    </div>
  </li>
  <li>P0 source code
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>         <span class="cm">/* P0 wants to enter the critical section */</span>
    <span class="n">turn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>               <span class="cm">/* IF P1 wants to enter the critical section, P1 has priority */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">;</span>                   <span class="cm">/* busy waiting */</span>
                            <span class="cm">/* critical section */</span>
        <span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>    <span class="cm">/* exit section */</span>
                            <span class="cm">/*remainder section */</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>æ³¨æ P0 æå¨ turn åªåè® P1 é²å¥ Critical sectionï¼åæ¨£ç P1 ä¹æå¨ turn åªåè® P0 é²å¥ Critical section
    <ul>
      <li>å°æ¹æ³é²å¥ Critical sectionï¼é£éº¼èªå·±å°±è®å°æ¹é²å¥ Critical section</li>
      <li>æ²æäººæ³é²å¥ Critical sectionï¼é£éº¼å°±èªå·±é²å¥ Critical section</li>
      <li>å°æ¹é¢é Critical section å¾ï¼èªå·±å°±å¯ä»¥é²å¥ Critical section</li>
    </ul>
  </li>
</ol>

<h5 id="55-proof-petersons-sol-to-satisfy-critical-section-three-conditions">5.5 Proof petersonâs sol to satisfy critical section three conditions</h5>

<p>Proof:</p>
<ul>
  <li><strong>Mutual Exclusion</strong>
    <ul>
      <li>Shard memory ä¸­ï¼Task é½è½ä¿®æ¹ turn, æä»¥ turn åªææå©åå¼ï¼0 æ 1</li>
      <li><code class="language-plaintext highlighter-rouge">write</code> å¿é æ¯ atomic operationï¼å¦å P0, P1 æå¯è½è®å°ä¸åçå¼</li>
    </ul>
  </li>
  <li><strong>Progress</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.  flag[0] = true;                 1.  flag[1] = true;
2.  turn = 1;                       2.  turn = 0;
3.  while (flag[1] &amp;&amp; turn == 1)    3.  while (flag[0] &amp;&amp; turn == 0)
</code></pre></div>    </div>
    <ol>
      <li>åè¨­ P0 æ³é²å¥ CSï¼P1 æ²ææ³é²å¥ CSï¼<code class="language-plaintext highlighter-rouge">flag[1] = false</code>ï¼éæ¨£å¯ä»¥ç´æ¥é²å¥ CS</li>
      <li>åè¨­ P0 æ³é²å¥ CSï¼P1 åªå·è¡å° flag[1] = trueï¼éæ¨£ P0 æé²å¥ busy waitingï¼ä½æ¯ P1 æå¨ turn = 0 åæ¬¡ç¦®è® P0 é²å¥ CS</li>
      <li>åè¨­ P0, P1 é½åæå·è¡å° while loopï¼ä½æ¯ turn æç¢ºä¿è³å°æä¸å Task æé²å¥ CS</li>
    </ol>
  </li>
  <li><strong>Bound Waiting</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.  flag[0] = true;                 1.  flag[1] = true;
2.  turn = 1;                       2.  turn = 0;
3.  while (flag[1] &amp;&amp; turn == 1)    3.  while (flag[0] &amp;&amp; turn == 0)
4.  flag[0] = false;                4.  while (flag[0] &amp;&amp; turn == 0)
5.  flag[0] = true;                 5.  while (flag[0] &amp;&amp; turn == 0)
6.  turn = 1;                       6.  while (flag[0] &amp;&amp; turn == 0)
7   while (flag[1] &amp;&amp; turn == 1)    7.  while (flag[0] &amp;&amp; turn == 0)
</code></pre></div>    </div>
    <ul>
      <li>éè£¡çéé»å¶å¯¦å¨æ¼ turnï¼ä¸æ¯ flagï¼å çº flag åªæ¯ä»£è¡¨èª°æ³é²å¥ CSï¼ä½æ¯ turn ä»£è¡¨èª°ææ¬å©é²å¥ CS</li>
      <li>åå¦ P0 æ flag è¨­çº false çæåï¼åå¥½ P1 è¢« ctx éæ¨£ä¹ä¸¦ä¸æé¯éé²å¥ CS çæ©æ</li>
      <li>æä»¥å¨ P0 ç¦®è®çææ³ä¸ï¼P1 ä¸å®æå¨ä¸æ¬¡é²å¥ CS</li>
    </ul>
  </li>
</ul>

<p>å¨éè£¡æè¦ºå¾å¥½å flag, turn çé åºå¦æèª¿æä¹ææä¸æ¨£çææï¼ä½æ¯è¨ä½ flag åªæ¯ä»£è¡¨èª°æ³é²å¥ CSï¼ä½æ¯ turn ä»£è¡¨èª°ææ¬å©é²å¥ CSï¼å¦æèª¿æææä»¥ä¸ææ³</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.  while(1) {                          1.  while(1) {
2.      turn = 1;                       2.
3.                                      3.  turn = 0;
4.                                      4.  flag[1] = true;
5.                                      5.  while (flag[0] &amp;&amp; turn == 0)
6.      flag[0] = true;                 6.  /* Critical Section */
7.      while (flag[1] &amp;&amp; turn == 1)    7.
8.      /* Critical Section */          8.
9.                                      9.  flag[1] = false;
10.     flag[0] = false;                10. /* Remainder Section */
11.     /* Remainder Section */         11. }
12. }                                   12.
</code></pre></div></div>

<ol>
  <li>P1 é²å¥ CS ä½æ¯æ¯å çº flag[0] = falseï¼èå¯¦éä¸ P0 ä¹æ³é²å¥ CS åªæ¯éæ²æå·è¡å°</li>
  <li>P0 é²å¥ CS ä½æ¯æ¯å çº turn = 0ï¼å°æ¹ç¦®è®ä½å¶å¯¦å°æ¹éå¨ CS ä¸­åªæ¯éæ²å° flag è¨­ç½®çº false
    <ul>
      <li>éæ¨£å°±æé æ P0, P1 åæé²å¥ CSï¼éå <code class="language-plaintext highlighter-rouge">Mutual Exclusion</code></li>
    </ul>
  </li>
</ol>

<p><strong>Proof flag must before turn:</strong></p>

<ol>
  <li>P0 å P1 åæå·è¡ï¼é½æå¯è½å»å·è¡ turnï¼å æ­¤ turn ä¸æ¯ 0 å°±æ¯ 1</li>
  <li>éè£¡çåææ¯ä¸å®ææ <code class="language-plaintext highlighter-rouge">flag[0] == flag[1] == 1</code> ä»£è¡¨å©èé½æ³é²å¥ CS
    <ul>
      <li>éåæ­¥é©æ¯å¿é çï¼å¿é åç¢ºèªè¦é²å¥ CSï¼ä¹å¾æè½å»ç¦®è®å°æ¹</li>
    </ul>
  </li>
</ol>

<blockquote>
  <p>çè§£éé¨åæ¯çºäºå¦æä¹å¾è¦è¨­è¨ spinlockï¼å³ä½¿æå¾å¤å·²ç¶å¯«å¥½çæ¼ç®æ³ï¼ä½æ¯ä¾ç¶æå¯è½å¨ç¹å¥çææ³ä¸éè¦èªå·±è¨­è¨ï¼æ­¤æçè§£éé¨åçè­æå°±éå¸¸éè¦</p>
</blockquote>

<h5 id="56-c11-implementation">5.6 C11 implementation</h5>

<p>å¨ C11 å¯¦ä½çæåè¦æ³¨æçæ¯ä½¿ç¨ <stdatomic.h> éåæ¨é ­æªï¼ä¸¦ä¸è¦æ³¨æ Compiler å¨å Optimizationï¼æå¯è½æéè¦çé¨ä»½çµ¦çç¥æï¼
å çº Optimization ä¿è­çæ¯ Single-thread çè¡çºï¼æä»¥å¨ Multi-thread çè¡çºä¸å°±ä¸ä¸å®ææ­£ç¢ºã</stdatomic.h></p>

<p><a href="https://gist.github.com/Hotshot824/c8d89af9fb5481a4a257d5692301490f">petersonâs-sol.c</a>ï¼ P0 çç¨å¼ç¢¼å¦ä¸ï¼æ³¨æå°è¦ä½¿ç¨ <code class="language-plaintext highlighter-rouge">atomic_store</code> é²è¡æä½ï¼ä¸¦ä¸å¨ <code class="language-plaintext highlighter-rouge">atomic_thread_fence()</code> ä¾ä¿è­ç·¨è­¯å¨æä½³åä¸æä¿®æ¹ç¨å¼ç¢¼çé åºã</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">atomic_int</span> <span class="n">turn</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">atomic_int</span> <span class="n">flag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="kt">void</span> <span class="nf">p0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"start p0</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">atomic_store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">atomic_thread_fence</span><span class="p">(</span><span class="n">memory_order_seq_cst</span><span class="p">);</span>
        <span class="n">atomic_store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">turn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">atomic_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flag</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">turn</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">;</span>
        <span class="cm">/* Critical Section */</span>
        <span class="n">in_cs</span><span class="o">++</span><span class="p">;</span>
        <span class="n">nanosleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">in_cs</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"p0åp1é½å¨critical section</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">p0_in_cs</span><span class="o">++</span><span class="p">;</span>
        <span class="n">nanosleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">in_cs</span><span class="o">--</span><span class="p">;</span>
        <span class="cm">/* Remainder Section */</span>
        <span class="n">atomic_store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>éåç¨å¼çå·è¡å°æå¦ä¸ï¼å¯ä»¥çå°ç¡è«å¤å°æ¬¡å·è¡éå©å Task é²å¥ CS çæ¬¡æ¸é½å¨ 1 çç¯åå§ã</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./peterson
start p0
start p1
p0: 3333, p1: 3332
p0: 6684, p1: 6684
p0: 10046, p1: 10046
p0: 13401, p1: 13400
p0: 16768, p1: 16768
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">atomic_sotre()</code> é±å«éè¦ä½¿ç¨ <code class="language-plaintext highlighter-rouge">atomic_thread_fence()</code></li>
  <li>å¦ææ³è¦æ´é«æçç code æè©²ä½¿ç¨:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">atomic_store_explicit(address, memory_order)</code></li>
      <li><code class="language-plaintext highlighter-rouge">atomic_load_explicit(address, memory_order)</code></li>
      <li>memory_order æå®ä½¿ç¨åªä¸ç¨®è¨æ¶é«æ¨¡å</li>
    </ul>
  </li>
  <li>å¦å¤è¦æ³¨æå¨ <code class="language-plaintext highlighter-rouge">signal</code> handler ä¸­ä¸æè©²ä½¿ç¨ <code class="language-plaintext highlighter-rouge">printf()</code> éé¨ç²å¯ä»¥åèç³»çµ±ç¨å¼è¨­è¨</li>
</ul>

<p><strong>Petersonâs solution conclusion</strong></p>

<ul>
  <li>Petersonâs solution æä¾ä¸åæ»¿è¶³ Critical section ä¸åæ¢ä»¶çç´è»é«æ¼ç®æ³</li>
  <li>å¦æ Critical section å¾é·ï¼CPU ææµªè²»å¤§éæéå¨ Busy waiting
    <ul>
      <li>ä¾å¦: P0 é²å¥ CS å¾è¦å·è¡ç´ 1 åéï¼P1 æå¨éæ®µæéä¸ç´å¨ Busy waitingï¼å¦ææ¯éæ¨£ P1 æè©²è¦éæ¾ CPU çµ¦å¶ä» Task åä½¿ç¨ï¼
ç­å°æéå°äºåå»æª¢æ¥æ¯å¦å¯ä»¥é²å¥ CSï¼ä¾å¦: <code class="language-plaintext highlighter-rouge">mutex</code> ä½¿ç¨ adaptive çæ¹å¼</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>mutex å¾é¢åæ¸ç <code class="language-plaintext highlighter-rouge">PTHREAD_MUTEX_ADAPTIVE_NP</code> ä»£è¡¨ä½¿ç¨ adaptive çæ¹å¼ï¼éæ¨£å°±å¯ä»¥é¿å busy waiting</p>
</blockquote>

<hr />

<h3 id="semaphore--mutex">Semaphore &amp; Mutex</h3>

<p><a href="./2023-11-09-synchronization.html#57-definition-of-semaphore">5.7 Definition of Semaphore</a><br />
<a href="./2023-11-09-synchronization.html#58-mutex">5.8 Mutex</a><br />
<a href="./2023-11-09-synchronization.html#59-mutex-in-libc">5.9 Mutex in libc</a><br />
<a href="./2023-11-09-synchronization.html#510-futex-in-linux">5.10 Futex in Linux</a></p>

<p>éè£¡ä¾ä»ç´¹è Petersonâs solution ä¸å¤ªä¸æ¨£çæ©å¶ Mutex è Semaphoreï¼æä¸»è¦çå·®ç°æ¯æå¯è½ç¢ç context switchï¼ä¸¦ä¸è· spinlock ä¸åçæç¨å ´æ¯æåªäºã
å¯¦éä¸ Mutex è Semaphore é½æ spinlock, sleep, wakeup éä¸åæ©å¶æå¯¦ä½ã</p>

<h5 id="the-difference-between-mutex-and-spinlock">The difference between Mutex and Spinlock</h5>

<ul>
  <li>Mutex lock ä¸æåæï¼å¹¾ä¹é½æå»å context switch
    <ul>
      <li>context switch éè¦å»èè²»ä¸äº CPU timeï¼æä»¥é¤éè¦ç­å¾ä¹å¦åä½¿ç¨ semaphore ææ¯è¼å¥½</li>
    </ul>
  </li>
  <li>Spinlock lock ä¸æåæï¼æä¸ç´å busy waiting(Loop)
    <ul>
      <li>loop æè® CPU ä¸æ·åè©¦é²å¥ CSï¼ä½å¦æç­å¾å¤ªä¹æé æ CPU è³æºçæµªè²»</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>ç­å¾æéé·æè©²ä½¿ç¨ Mutexï¼ç­å¾æéç­æè©²ä½¿ç¨ Spinlock</p>
</blockquote>

<ul>
  <li>Spinlock éå¸¸æè½æ¯ Mutex å¥½ï¼æä»¥ Database ç­å¤§åè»é«æä½¿ç¨ Spinlock
    <ul>
      <li>ä½å¦æ task ææ lock ä½è¢« scheduleoutï¼æé æå¶ä» task ä¸ç´å¨ busy waiting</li>
    </ul>
  </li>
  <li>Semaphore, Mutex ä¸­ç­å¾ç task é½è¢« scheduleoutï¼æä»¥ä¸æé æ busy waiting</li>
</ul>

<h5 id="57-definition-of-semaphore">5.7 Definition of Semaphore</h5>

<p><strong>Semaphore çå®ç¾©:</strong></p>
<ul>
  <li>åå¦ç¾å¨æ P1 - P4 è¦é²å¥ CS é½å·è¡å° while(S &lt;= 0)
    <ul>
      <li>æ­¤æææ lock ç task ç¼åº signalï¼S++</li>
      <li>P1 - P4 ä¸å®ææä¸åäººé¢é while loopï¼å·è¡ Sâ;
        <ul>
          <li>å¨éè£¡å¿é åè¨­éåæ­¥é©æ¯ä¸æ¬¡å·è¡å®ç¢ï¼æä»¥ä¸ææå¶ä» task åæé¢é while loop</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>è¦æ³¨æéè£¡åªæ¯ä¸åå®ç¾©ï¼èä¸æ¯å¯¦ç¾çæ¹å¼</li>
</ul>

<p><img src="/image/2023/11-09-synchronization/2.png" alt="" height="100%" width="100%" /></p>

<p><strong>Semphore çå¯¦ä½æ¨£è²:</strong></p>
<ul>
  <li>wait: æ³è¦é²å¥ CS ç task å¼å« wait()
    <ol>
      <li>valueâ, å¦æ value &lt; 0 å°±é²å¥ list ç­å¾</li>
      <li>sleep(), å¼å« scheduler context switch</li>
    </ol>
  </li>
  <li>signal: é¢é CS ç task å¼å« signal()
    <ol>
      <li>value++, å¦æ value &lt;= 0 ä»£è¡¨æ task å¨ç­å¾</li>
      <li>wakeup(), å¾ list ä¸­ååºä¸å task ä¸¦ä¸åéå¾ sleep() å¾ä¸å·è¡</li>
    </ol>
  </li>
</ul>

<p><img src="/image/2023/11-09-synchronization/3.png" alt="" height="100%" width="100%" /></p>

<p><strong>Semphore çä½¿ç¨æ¹å¼:</strong></p>
<ul>
  <li>Semphore ç value å¯ä»¥æ¯:
    <ul>
      <li><strong>0&lt;</strong>: ä»£è¡¨æå¤å task å¨ç­å¾</li>
      <li><strong>=0</strong>: æ²æ task å¨ç­å¾ï¼éå¸¸æ¯åå§åççæ</li>
      <li><strong>&gt;0</strong>: ä»£è¡¨ä¸æ¬¡æå¤æ X å task å¯ä»¥é²å¥ CS
        <ul>
          <li>ä¾å¦: ä¸æ¬¡æå¤ 3 å task å¯ä»¥é²å¥ CSï¼value çåå§å¼å°±æ¯ 3ï¼é²å¥ 3 å°å¾ value = 0ï¼æ­¤æä¸ä¸å task å·è¡ valueâ å°±æé²å¥ list ç­å¾</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>éå¸¸ææä¸å Struct ä¾ç®¡ç Semphoreï¼value æ¯ç¡æ³ç´æ¥ä¿®æ¹çï¼å¿é ä½¿ç¨ä»è¨­è¨çå½æ¸</li>
</ul>

<h5 id="58-mutex">5.8 Mutex</h5>

<p>ç¸è¼æ¼ Semphoreï¼Mutex å¯ä»¥ææ´å¤ç¹è²</p>
<ul>
  <li>å¯ä»¥å¤æ·æ¯èª° Lock ä½ Mutex (owner)</li>
  <li>å¯ä»¥æ¯æ´ Priority inheritance</li>
  <li>å¯ä»¥æ¯æ´æä¸æ¯æ´ Nested lock</li>
  <li>å¯ä»¥æ¯æ´ Adaptive lock
    <ul>
      <li>åå¦æä¸ç¥éæè©²ä½¿ç¨ spinlock éæ¯ mutexï¼å¯ä»¥ä½¿ç¨ adaptive lockï¼éæ¨£å°±å¯ä»¥èªåé¸æ</li>
    </ul>
  </li>
</ul>

<p><strong>Adaptive Mutex</strong></p>

<p>å¦æ <strong>p</strong> å <strong>q</strong> ç«¶ç­ Mutex(lock)ï¼éè£¡è¨è« p çææ³</p>
<ul>
  <li>Mutex æ²ä¸éï¼p ç²å¾ lock</li>
  <li>Mutex å·²ä¸éï¼q ææ lock
    <ol>
      <li>q å¨å¦ä¸é¡ CPUï¼ä¸¦ä¸ q å¨ OS ç waiting queue ä¸­ï¼ä¾å¦: q å¨ç­å¾ I/O
        <ul>
          <li>p æé²å¥ sleep ç­å¾ mutex(context switch)</li>
          <li>q æ¢ç¶å·²ç¶é²å¥äº waiting queue é£ä»£è¡¨å¯è½å¨éä¸å epoch å§é½ä¸æåå·è¡ï¼é£éº¼ p ä¹å°±ä¸éè¦åå»ç´ç´ç­å¾äº</li>
        </ul>
      </li>
      <li>q å¨å¦ä¸é¡ CPUï¼ä½æ¯ q ä¸å¨ OS ç waiting queue ä¸­ï¼ä»£è¡¨ q å¨éç®
        <ul>
          <li>p æé²å¥ busy waitingï¼ç´å° q éæ¾ lock</li>
          <li>q å çºå¨å·è¡ï¼æä»¥ä»£è¡¨ q æå¨ç­æéå§éæ¾ lockï¼å æ­¤ p å» spinlock ç­å¾æè¨±æ¯ ctx æ´ææç</li>
        </ul>
      </li>
      <li>q å p å¨åä¸é¡ CPUï¼å p é²å¥ sleep ç­å¾ mutex(context switch)
        <ul>
          <li>æ¢ç¶å¨åä¸é¡ CPUï¼é£éº¼ p è·å»å busy waiting ä¹æ²ææç¾©ï¼åèå»æ¶å¥ª CPU è³æºé æ q ä¹è®æ¢ï¼
q è®æ¢ä»£è¡¨ q éæ¾ lock çæéä¹æè®æ¢ï¼å æ­¤ p é²å¥ sleep ç­å¾ mutex ææ¯è¼å¥½</li>
          <li>éè£¡å¯ä»¥èç±ç¡¬é«çæ¯æ´ï¼ä¾ä½¿ç¨ä¾å¦ pause(), mwait() éæ¨£çæä»¤ä¾è® p ç vcore è®æ¢ï¼è® q ææ©æéæ¾ lock</li>
        </ul>
      </li>
    </ol>
  </li>
</ul>

<blockquote class="block-warning">
  <p>ä»¥ä¸çéäºæå¢é½ä»£è¡¨ p å¿é è¦ç¥é mutex ææèççæï¼éæ¨£æè½æ±ºå®èªå·±è¦é²å¥ sleep éæ¯ busy waiting</p>
</blockquote>

<blockquote>
  <p>ééä»ç´¹ç Adaptive Mutex åºèªæ¼ Sun Solarisï¼Adaptive éæå¾å¤å¯¦ä½æ¹å¼</p>
</blockquote>

<h5 id="59-mutex-in-libc">5.9 Mutex in libc</h5>

<p><a href="https://github.com/lattera/glibc/blob/master/nptl/pthread_mutex_lock.c">glibc/nptl/pthread_mutex_lock.c</a> glibc ä¸­ç Adaptive Mutex å¯¦ä½åæ¯å»ä¾ç§éå»ç­å¾éå lock æéæ¾çæéä¾è¨­å® <strong>spinlock</strong> ç loop æ¬¡æ¸ï¼
å¦æè¶éæ¬¡æ¸éç¡æ³æåï¼é£å°±éæ¾ CPU è³æºï¼ä¸¦ä¸é²å¥ sleepã</p>
<ul>
  <li>LLL_MUTEX_LOCK(mutex)</li>
</ul>

<blockquote class="block-warning">
  <p>å¦æéè¦ä½¿ç¨ Lock çæåï¼å¦æå°ç³»çµ±ä¸çæï¼ç¡éé¿åé¨ä¾¿å»ä½¿ç¨ spinlockï¼å¯ä»¥ä½¿ç¨ Adaptive Mutex</p>
</blockquote>

<p><a href="https://gist.github.com/Hotshot824/696bc2c9bede5a64a13f3e330a51c34b">signal-wait-adptive-mutex.c</a> æåä¾å·è¡éåç¯ä¾ç¨å¼:</p>
<ul>
  <li>å¨éåç¨å¼ä¸­ä½¿ç¨äº semaphore ä¾ç¢ºä¿ p ææ¯ q åå·è¡</li>
  <li>å»è§å¯ p æ¯å¦å·è¡ usleep()
    <ul>
      <li>æï¼context switch çæ¬¡æ¸è®å¤ï¼å çº q ç­ä¸å° p éæ¾ lockï¼æä»¥ q æå»å context switch</li>
      <li>æ²æï¼context switch çæ¬¡æ¸è®å°ï¼å çºç¨å¼å¾ç­ï¼æä»¥ q æå»å busy waiting ç­ p éæ¾ lock</li>
    </ul>
  </li>
</ul>

<p><img src="/image/2023/11-09-synchronization/4.png" alt="" height="100%" width="100%" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Performance counter stats <span class="k">for</span> <span class="s1">'./exam3.exe'</span>:

              6.45 msec task-clock                       <span class="c">#    0.598 CPUs utilized          </span>
               200      context-switches                 <span class="c">#   31.027 K/sec                  </span>
                 0      cpu-migrations                   <span class="c">#    0.000 /sec                   </span>
                57      page-faults                      <span class="c">#    8.843 K/sec                  </span>
   &lt;not supported&gt;      cycles                                                      
                 0      stalled-cycles-frontend                                            
                 0      stalled-cycles-backend           <span class="c">#    0.00% backend cycles idle    </span>
   &lt;not supported&gt;      instructions                                                
   &lt;not supported&gt;      branches                                                    
   &lt;not supported&gt;      branch-misses                                               

       0.010775604 seconds <span class="nb">time </span>elapsed

       0.000000000 seconds user
       0.010204000 seconds sys
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Performance counter stats <span class="k">for</span> <span class="s1">'./exam3.exe -s'</span>:

             11.75 msec task-clock                       <span class="c">#    0.529 CPUs utilized          </span>
               400      context-switches                 <span class="c">#   34.055 K/sec                  </span>
                 0      cpu-migrations                   <span class="c">#    0.000 /sec                   </span>
                60      page-faults                      <span class="c">#    5.108 K/sec                  </span>
   &lt;not supported&gt;      cycles                                                      
                 0      stalled-cycles-frontend                                            
                 0      stalled-cycles-backend           <span class="c">#    0.00% backend cycles idle    </span>
   &lt;not supported&gt;      instructions                                                
   &lt;not supported&gt;      branches                                                    
   &lt;not supported&gt;      branch-misses                                               

       0.022206888 seconds <span class="nb">time </span>elapsed

       0.000000000 seconds user
       0.018481000 seconds sys
</code></pre></div></div>

<blockquote>
  <p>ä¸é¢æ¯å»å·è¡ perf ççµæï¼èé æççµæç¸ç¬¦</p>
</blockquote>

<p><strong>Pthread mutex function</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pthread_mutex_init()</code>: Initialize mutex</li>
  <li><code class="language-plaintext highlighter-rouge">pthread_mutex_destroy()</code>: Destroy mutex</li>
  <li><code class="language-plaintext highlighter-rouge">pthread_mutex_lock()</code>: Lock mutex(blocking)</li>
  <li><code class="language-plaintext highlighter-rouge">pthread_mutex_trylock()</code>: Lock mutex(non-blocking), if mutex is unlocked, lock it and return 0, else return EBUSY.</li>
  <li><code class="language-plaintext highlighter-rouge">pthread_mutex_unlock()</code>: Unlock mutex</li>
  <li><code class="language-plaintext highlighter-rouge">pthread_mutexattr_()</code>: Mutex attribute</li>
</ul>

<h5 id="510-futex-in-linux">5.10 Futex in Linux</h5>

<p>Spinlock å¯ä»¥ç´æ¥å¨ userspace å¯¦ä½ï¼è Kernel ç¡éï¼ä½æ³å»å¯¦ä½ Semaphore, Mutex å°±éè¦ Kernel çæ¯æ´ï¼å çºéå©åæ©å¶é½éè¦å»å context switchï¼
<a href="https://man7.org/linux/man-pages/man2/futex.2.html">futex</a> å°±æ¯ Linux kernel æä¾çä¸åæ©å¶ï¼å¯ä»¥å¨ userspace å¯¦ç¾ Semaphore, Mutexã</p>

<ul>
  <li>futex æéé futex_op ä¾æ±ºå® mutex çè¡çº</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">SYS_futex</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">futex_op</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">val</span><span class="p">,</span>
            <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">timeout</span><span class="p">,</span>   <span class="cm">/* or: uint32_t val2 */</span>
            <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">uaddr2</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">val3</span><span class="p">);</span>

<span class="c1">// Note: glibc provides no wrapper for futex(), necessitating the use of syscall(2).</span>
</code></pre></div></div>

<blockquote class="block-danger">
  <p>æ³¨æ glibc ä¸­ä¸¦æ²æå»å¯¦ä½ futex()ï¼å çºéæ¯ä¸ååéæ¼ Linux çç³»çµ±å¼å«ï¼æä»¥è¦ä½¿ç¨ syscall() ä¾å¼å«<br />
syscall(SYS_futex, uaddr, FUTEX_WAIT, val, timeout, uaddr2, val3);</p>
</blockquote>

<p><strong>futex - fast user-space locking</strong></p>
<ul>
  <li>ä»¥ä¸ç Function é½åªæ¯æ <code class="language-plaintext highlighter-rouge">int futex_op</code> ä¾ç¶ä½ Pseudo code ä¾ç</li>
  <li>Main fuctions
    <ul>
      <li>futex_wait(&amp;expected, desired, timeout)
        <ul>
          <li>ç­å¾ expected == desiredï¼timeout ä»£è¡¨ç­å¾çæéï¼å¦æ timeout == NULL ä»£è¡¨ç¡éæç­å¾</li>
        </ul>
      </li>
      <li>futex_wake(&amp;val, newVal, maxWakeup)
        <ul>
          <li>æ val è¨­çº newValï¼ä¸¦ä¸åé maxWakeup åç­å¾è©² val è®çº newVal ç task</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Priority Inheritance(åªåæ¬ç¹¼æ¿)</strong>: éæ¯çºäºé¿å Priority Inversion(åªåæ¬åè½)æè¨­è¨ç
    <ul>
      <li>futex_wait_pi(&amp;expected, desired, timeout)</li>
      <li>futex_wakeup_pi(&amp;val, newVal, maxWakeup)</li>
      <li>å¦ææ­£å¨ç­å¾ç task ä¸­ææ¯èªå·±åªåæ¬é«ç taskï¼ææ lock ç task å¨ææ lock çæéææèªå·±çåªåæ¬æåå°è·ç­å¾ç task åç­</li>
      <li>Unlock å¾åªåæ¬æé«ç task æåªååå¾ lock</li>
    </ul>
  </li>
</ul>

<blockquote class="block-warning">
  <p>Priority Inversion æ¯æä½åªåæ¬ç task ææ lockï¼ä½æ¯é«åªåæ¬ç task æ­¤æä¹æ³ææ lockï¼å°è´é«åªåæ¬ç task ç­å¾ä½åªåæ¬ç task éæ¾ lock</p>
</blockquote>

<hr />

<h3 id="use-semaphore-to-solve-common-problems">Use Semaphore to Solve Common Problems</h3>

<p><a href="./2023-11-09-synchronization.html#511-producer-consumer-problem">5.11 Producer-Consumer Problem</a><br />
<a href="./2023-11-09-synchronization.html#512-readers-writers-problem">5.12 Readers-Writers Problem</a><br />
<a href="./2023-11-09-synchronization.html#513-dining-philosophers-problem">5.13 Dining Philosophers Problem</a><br />
<a href="./2023-11-09-synchronization.html#514-514-what-is-the-correct">5.14 What is the correct</a></p>

<h5 id="511-producer-consumer-problem">5.11 Producer-Consumer Problem</h5>

<ul>
  <li>æ¯è¼ç°¡å®çææ³æ¯ãä¸å Producerãããä¸å Consumerã
    <ul>
      <li>éç¨®ææ³ä¸ä½¿ç¨ atomic_write, atomic_read ä¾åµé ä¸å out, in ç <a href="https://en.wikipedia.org/wiki/Circular_buffer">Circular queue</a> ä¾è§£æ±º</li>
    </ul>
  </li>
  <li>ãå¤å Producerãããå¤å Consumerãï¼ä¾å¦: å¤å Produer åæè¦ä¿®æ¹ in
    <ul>
      <li>å¦ææ read + modify(compare) + write å¯ä»¥ç¨ä¸åç¡¬é«æä»¤ä¾è§£æ±ºï¼æ¯å¦æ¯æ¯è¼ææççæ¹å¼?</li>
    </ul>
  </li>
</ul>

<p><img src="https://media.geeksforgeeks.org/wp-content/uploads/Circular-queue_1.png" alt="" height="100%" width="100%" /></p>

<blockquote>
  <p>ä¸åæ¯ Circular queue çæ¦å¿µï¼éè£¡ç in, out ä»£è¡¨çæ¯ indexï¼èä¸æ¯å¯¦éçè³æ</p>
</blockquote>

<p><img src="/image/2023/11-09-synchronization/5.png" alt="" height="100%" width="100%" /></p>

<blockquote>
  <p>ä»¥ä¸æ¯ä¸åç¯ä¾ï¼åè¨­ Producer æ¯ NICï¼Consumer æ¯ OS</p>
</blockquote>

<ul>
  <li>Queue å²å­çå¯è½æ¯ä¸å pointerï¼æåå²å­è³æçè¨æ¶é«
    <ul>
      <li>NIC éé DMA æè³æå¯«å¥è¨æ¶é«ï¼ä¸¦ä¸ä¿®æ¹ in</li>
      <li>OS åå®è³æå¾ï¼ä¿®æ¹ out</li>
    </ul>
  </li>
  <li>åå¦æ­¤ææ¯ä¸å°ä¸çææ³ï¼è§£æ±ºæ¹æ³å¦ä¸ï¼æ³¨æéè£¡å¶å¯¦æè©²è¦ä½¿ç¨ atomic ä¾å¯¦ä½:
    <ul>
      <li>Producer æå·è¡ insert() å¯«å¥è³æ
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">insert</span><span class="p">()</span> <span class="p">{</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">input</span><span class="p">();</span> <span class="cm">/* Produce an item */</span>
    <span class="k">while</span> <span class="p">(((</span><span class="n">in</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">out</span><span class="p">)</span> <span class="cm">/* Only read in and out */</span>
        <span class="p">;</span> <span class="cm">/* Busy waiting, because no free buffer */</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span> <span class="cm">/* Insert item */</span>
    <span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="n">in</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span> <span class="cm">/* Update in */</span>
<span class="p">}</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>Consumer æå·è¡ remove() è®åè³æ
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">remove</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">in</span> <span class="o">==</span> <span class="n">out</span><span class="p">)</span> <span class="cm">/* Only read in and out */</span>
          <span class="p">;</span> <span class="cm">/* Busy waiting, because no free buffer */</span>
      <span class="n">item</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">out</span><span class="p">];</span> <span class="cm">/* Remove item */</span>
      <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span> <span class="cm">/* Update out */</span>
      <span class="n">output</span><span class="p">(</span><span class="n">item</span><span class="p">);</span> <span class="cm">/* Consume the item */</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>å¨éåä¾å­è£¡é¢ in, out é½åªæä¸å task æå»ä¿®æ¹ï¼æä»¥åªè¦ä½¿ç¨ atomic_write, atomic_read å°±å¯ä»¥è§£æ±º</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>è¦æ³¨æä¸é¢çä¾å­é½ä½¿ç¨äº Busy waitingï¼å¦æç¨å¼ä¸¦æ²æé«éçè®å¯«ï¼é£éº¼éæ¨£çåæ³æé æ CPU è³æºçæµªè²»</p>
</blockquote>

<h5 id="512-readers-writers-problem">5.12 Readers-Writers Problem</h5>

<ul>
  <li>Reader-Writer Problem çå®ç¾©å¦ä¸:
    <ul>
      <li>Reader åªå¯ä»¥è®ï¼Writer å¯ä»¥è®ä¹å¯ä»¥å¯«</li>
      <li>Reader å¯ä»¥åæå¤å Reader ä¸èµ·è®åä¸åè³æçµæ§</li>
      <li>Writer åä¸æéå§åªè½æä¸åå»å­åè³æçµæ§</li>
    </ul>
  </li>
  <li>å¯¦ä½ä¸æååè¨­æä¸ç³»åç Writer, Reader é²å¥æåºæºåé²å¥ CS: <code class="language-plaintext highlighter-rouge">rrrwrr</code>
    <ol>
      <li>æ <code class="language-plaintext highlighter-rouge">rrrwrr</code> è½ææ <code class="language-plaintext highlighter-rouge">rrrrrw</code> åªåèç Reader
        <ul>
          <li>ä½éæ¨£çåé¡æ¯ï¼åå¦åä¸æéå§ä¸æ·æ r é²å¥ï¼é£éº¼ w å°±æä¸ç´ç­å¾ï¼å¿é è¨­è¨ä¸åæ©å¶èç w</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">rrrwrrï¼r</code> è· w ä¹éå¿é  FIFOï¼ä½é£çºç r å¯ä»¥åæé²å¥ CS
        <ul>
          <li>æä»¥å·è¡é åºæè®æ <code class="language-plaintext highlighter-rouge">rrr</code> -&gt; <code class="language-plaintext highlighter-rouge">w</code> -&gt; <code class="language-plaintext highlighter-rouge">rr</code></li>
        </ul>
      </li>
    </ol>
  </li>
  <li>éè£¡çç®æ¨æ¯ç¡éæé«å¹³è¡åº¦ï¼è®å¤å Reader åæé²å¥ CS</li>
</ul>

<p><img src="/image/2023/11-09-synchronization/6.png" alt="" height="100%" width="100%" /></p>

<p>åå¦æä»¥ä¸ç¯ä¾ç¨å¼:</p>
<ul>
  <li>writer åªéè¦å» wait(rw_mutex) ä¹å°±æ¯ lockï¼è· signal(rw_mutex) ä¹å°±æ¯ unlock å°±å¯ä»¥</li>
  <li>reader:
    <ol>
      <li>æéé ­ç wait(mutex) å° signal(mutex) æ¯çºäº lock CS è®æ­¤æåªæ reader å¯ä»¥é²å¥
        <ul>
          <li>readcount == 1 ä»£è¡¨éæ¯ç¬¬ä¸å readerï¼æä»¥è¦å» lock CS ä¸è® writer é²å¥</li>
        </ul>
      </li>
      <li>é¢éè¦æª¢æ¥ readcount == 0 ä»£è¡¨æå¾ä¸åé¢éç readerï¼unlock è® writer æ­¤æå¯ä»¥é²å¥</li>
    </ol>
  </li>
  <li>åè¨­ç¾å¨æä¸å writer æ­£å¨ CS ä¸­ï¼æ­¤ææ r0, r1, r2 è¦é²å¥ CS
    <ol>
      <li>r0 æåé²å¥ wait(rw_mutex)ï¼æ­¤æ writer æ­£å¨ CS ä¸­ï¼æä»¥ r0 æé²å¥ sleep</li>
      <li>r1, r2 æé²å¥ wait(mutex)ï¼lock è¢« r0 æ¿èµ°ï¼æä»¥ r1, r2 æé²å¥ sleep</li>
      <li>writer é¢é CS ä¸¦ä¸ signal(rw_mutex)ï¼æ­¤æ r0 æ singal(mutex)ï¼è® r1, r2 å¯ä»¥ä¾åºé²å¥ Reading</li>
    </ol>
  </li>
</ul>

<blockquote>
  <p>å¨å¯¦éä½¿ç¨æï¼å¯ä»¥ä½¿ç¨ pthread å§å»ºç rwlock</p>
</blockquote>

<h5 id="513-dining-philosophers-problem">5.13 Dining Philosophers Problem</h5>

<p>å¦ä¸åæç¤ºï¼ä¸ç¾¤å²å­¸å®¶åå¨åæ¡ä¸ï¼æ¯åå²å­¸å®¶é¢åé½æä¸åç¤å­ï¼èç¤å­ä¹éäº¤é¯èåå</p>
<ul>
  <li>å²å­¸å®¶åé£¯æå¿é æ¿èµ·å·¦å³å©éçååæè½åé£¯</li>
  <li>æä»éº¼æ¹æ³è®ææçå²å­¸å®¶é½è½åå°é£¯?</li>
</ul>

<p><img src="/image/2023/11-09-synchronization/7.png" alt="" height="100%" width="100%" /></p>

<p>å¯è½çè§£æ±ºæ¹æ³:</p>
<ol>
  <li>ææäººé½åæ¿å·¦éçé¤å·ï¼åæ¿å³éçé¤å·
    <ul>
      <li>å¯è½ææäººé½æ¿å°å·¦éçé¤å·ï¼é½ç­ä¸å°å³éçé¤å·ï¼é ææ­»çµ</li>
    </ul>
  </li>
  <li>å°ææäººç·¨èï¼å¥æ¸åæ¿å·¦éçé¤å·ï¼å¶æ¸åæ¿å³éçé¤å·
    <ul>
      <li>æå¯è½æäººéæ°£å¾å·®ï¼ä¸ç´æ¿ä¸å°é¤å·ï¼ä¸ç¬¦å Bound waiting</li>
    </ul>
  </li>
  <li>è¼ªæµç²å¾é«åªåæ¬ï¼æ¿å°é¤å·çäººå¯ä»¥åé£¯ç¶å¾æ¾ä¸é¤å·ï¼ç´å°ææäººé½åå®
    <ul>
      <li>è¼ªæµç²å¾é«åªåæ¬ï¼å¯è½æé ææè½ç¶é ¸</li>
    </ul>
  </li>
</ol>

<p><strong>The Dining Philosophers Problem in Linux Kernel</strong></p>

<p><img src="/image/2023/11-09-synchronization/8.png" alt="" height="100%" width="100%" /></p>

<ul>
  <li>æ¯é¡ CPU ä¸é½æä¸å migration threadï¼ç¶ CPU æç©ºéæï¼migration thread æå»æª¢æ¥ææ²æ task æ³è¦å·è¡</li>
  <li>pull: migration/0 ç¼ç¾æçå·¥ä½éå¤ªå°ï¼æä»¥å»æ¬ç§» migration/3 çå·¥ä½</li>
  <li>push: migration/3 ç¼ç¾æçå·¥ä½éå¤ªå¤ï¼æä»¥æå·¥ä½æ¬ç§»çµ¦ migration/0</li>
  <li>æ­¤æå°±è¦é¿å migration/0, migration/3 éè¤äºæ¬ç§»å·¥ä½ï¼ä¾å¦:
    <ol>
      <li>ä¾ç§ CPU ç·¨èï¼åªåéç·¨èå°ç CPUï¼éæ¨£å°±åªæä¸å migration thread æåå·è¡</li>
      <li>æ¬ç§»çµæå¾æ­¤æå·¥ä½éæå¹³åï¼æä»¥ä¸æåæ migration thread å»æ¬ç§»å·¥ä½</li>
    </ol>
  </li>
</ul>

<blockquote>
  <p>å¨éåä¾å­ Linux ä¸¦æ²æå»èæ® bound waitingï¼å çº 0 æåäºçè©± 1 ä¹å°±ä¸ç¨å·è¡äº</p>
</blockquote>

<h5 id="514-what-is-the-correct">5.14 What is the correct</h5>

<p>ç¶å¤å Process åæå¨å·è¡ï¼å¨ä¿®æ¹çæåè¦æéº¼å»ç¢ºä¿è³æçæ­£ç¢ºæ§ï¼ä»éº¼æ¯æ­£ç¢ºç?</p>

<p>åå¦æ Task1, Task2 åæè¦ä¿®æ¹ä¸åè³æ A</p>
<ol>
  <li>Task2 åè®å Aï¼ç¶å¾ä»¥ A çºåºç¤åä¸äºéç®</li>
  <li>Task1 å¨ Task è®åå¾ï¼æè®å A ä¸¦ä¿®æ¹ Aï¼ç¶å¾ Task2 æçµæéç®
    <ul>
      <li>éæ¨£çææ³ä¸ Task2 æå¾éç®ççµææ¯é¯èª¤çï¼å çº Task2 ä»¥ A çºåºç¤åéç®ï¼ä½æ¯ A å·²ç¶è¢« Task1 ä¿®æ¹äº</li>
    </ul>
  </li>
</ol>

<p>åæ¨£å©å Taskï¼ä½æ¯éæ¬¡ Task2 å¨ Task1 è®ååå°±åå®éç®</p>
<ul>
  <li>ä½æ¯å¯¦éä¸éå©æ¬¡ Task2 æå¾ççµæé½æ¯ä¸æ¨£ç</li>
  <li>å æ­¤å¦æä»¥ Task2 ççµæä¾å¤æ·æ­£ç¢ºæ§ï¼é£éº¼å¯ä»¥èªªéå©æ¬¡ææ¯æ¯ç­å¹ç</li>
</ul>

<p><img src="/image/2023/11-09-synchronization/9.png" alt="" height="100%" width="100%" /></p>

<blockquote>
  <p>æ¯å¦å¯ä»¥æå¹³è¡åä»¥å¾çæ­£ç¢ºæ§å®ç¾©çºãå¶çµæç­å¹æ¼æåä¾åºå·è¡ççæ³ã</p>
</blockquote>

<hr />

<h3 id="atomic-operation">Atomic Operation</h3>

<blockquote class="block-warning">
  <p>åé¢æåä»ç´¹ Computer Orangization çä¸äºåºç¤ï¼å¾é¢ä»ç´¹ä½¿ç¨ Atomic Operation æç¢ççææ¬</p>
</blockquote>

<p><a href="./2023-11-09-synchronization.html#515-mesh-architecture">5.15 Mesh-Architecture</a><br />
<a href="./2023-11-09-synchronization.html#516-dma-with-cache-coherence">5.16 DMA with Cache Coherence</a><br />
<a href="./2023-11-09-synchronization.html#517-cache-coherence-vs-atomic-operation">5.17 Cache coherence vs Atomic operation</a><br />
<a href="./2023-11-09-synchronization.html#518-atomic-operation">5.18 Atomic operation</a><br />
<a href="./2023-11-09-synchronization.html#519-atomic-operation-in-c11">5.19 Atomic operation in c11</a></p>

<p>ä½¿ç¨ Atomic operation æç¢ççææ¬è·ä¸è¬çæä»¤ä¸å¤ªä¸æ¨£ï¼ä¸¦ä¸æä¾ç§åå½±é¿ç CPU çåæ¸èææä¸åãä¸¦ä¸å¨ SMP ä¸å¦æææ CPU æ¯æ¬¡å­åè³æé½è¦å° DRAMï¼
é£ DRAM å°±ææ¯ä¸å Bottleneckï¼æä»¥ææ Cache çæ©å¶ï¼ä½æ¯ Cache å°±è¦å»èç Cache coherence çåé¡ã</p>

<blockquote>
  <p>å¨åæ­¥æ©å¶ä¸ï¼ä¸åçæä»¤æå½±é¿å°ç CPU æ¸éä¸åï¼æä»¥ææ¬ä¹ä¸å</p>
</blockquote>

<p><img src="/image/2023/11-09-synchronization/10.png" alt="" height="100%" width="100%" /></p>

<p>ä¸åä¸­ L2 cache ä¹éææä¸äºåæ­¥æ©å¶ï¼è L3 chache ä¹ææä¸äºåæ­¥æ©å¶ï¼ä¾å¦: <a href="https://en.wikipedia.org/wiki/Bus_snooping">SNOOP</a> + dictionary</p>

<p><strong>Bus</strong>
Bus ä¹æåç¨®åæ¨£çé¡å</p>
<ul>
  <li>æ¯æ´ Broadcast ç Bus (Core æ¸éå°)</li>
  <li><a href="https://en.wikipedia.org/wiki/Ring_network">Ring</a> Bus (Core æ¸éå¤)</li>
  <li><a href="https://en.wikipedia.org/wiki/Mesh_networking">Mesh</a> Bus (Core æ¸éæ¥µå¤)</li>
  <li>ä¸è¦åçé£æ¥å (AMD éå±¤å¼æ¶æ§)</li>
</ul>

<h5 id="515-mesh-architecture">5.15 Mesh-Architecture</h5>

<p>éè£¡ä»¥ <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/xeon-processor-scalable-family-technical-overview.html">IntelÂ® XeonÂ® Processor Scalable Family Technical Overview</a> çºä¾ï¼ä¾äºè§£ Coherence çä»£å¹</p>

<p><img src="/image/2023/11-09-synchronization/11.png" alt="" height="100%" width="100%" /></p>

<ul>
  <li>Core å³éè³æçæ¹å¼æ¯éé Meshï¼åèµ° X åèµ° Y
    <ul>
      <li>CHA(Cache Home Agent): é¡ä¼¼ directoryï¼è¨éè³æå¨é£äº Core</li>
      <li>SF(Snoop Filter): ç£è½ Bus ä¸çå»£æ­ï¼æ¯å¦èèªå·±æé</li>
      <li>LLC(Last Level Cache): æå¾ä¸å±¤ç Cache</li>
    </ul>
  </li>
  <li>æä¸å±¤å°±æ¯å°å¤çéè¨ä»é¢ï¼ä¾å¦: PCIe, UPI</li>
  <li>å·¦å³åæä¸åééï¼ç¨ä¾é£æ¥ DDR4ï¼æä»¥å·¦å³ç Core æåªåä½¿ç¨èªå·±å´ç DDR4</li>
</ul>

<p><strong>Ultra Path Interconnect(UPI)</strong></p>

<p><img src="/image/2023/11-09-synchronization/12.png" alt="" height="100%" width="100%" /></p>

<ul>
  <li>UPI æ¯ä¸ç¨®æ´å±ç³»çµ±çä¸è´æ§åå®ï¼è®å¤åèçå¨å¯ä»¥å±äº«è³æï¼ä¸¦ä¸å¨åä¸å Memory space</li>
  <li>æ¯æ´ UPI ç Intel Xeon èçå¨ææä¾ 2~3 å UPI ééï¼ä¾é£æ¥å°å¶ä» Xeon èçå¨</li>
  <li>UPI ä¹éä½¿ç¨ Directory-based home snoop coherency protocol ä¾ç¶­æä¸è´æ§</li>
</ul>

<p><strong>Cache Coherence</strong></p>

<p>CPU å¿é ç¨ä¸äºæ¹æ³ä¿è­ææç Core çå°çè³æé½æ¯ä¸è´çï¼å¦å Shared Memory å°±æ²ææç¾©</p>
<ul>
  <li>Cache coherence problem: ä¸å CPU æä¸åç Cacheï¼æä»¥å¯è½æææ°èè³æçåé¡</li>
  <li>Cache coherence protocol: ä¸ç¨®æ©å¶ï¼ç¨ä¾ç¢ºä¿ææ CPU çå°çè³æé½æ¯ä¸è´ç
    <ul>
      <li>Snooping: ä»¥å»£æ­çæ¹å¼ä¾ç¶­æä¸è´æ§ï¼ä¿®æ¹è³æææéç¥å¶ä» CPU</li>
      <li>Directiory: å¨æ¯å Cache line ä¸é½æä¸å Directoryï¼ç´éææ°çè³æå¨é£äº Cacheï¼éæ¨£å°±åªéè¦éç¥æéç CPU
        <ul>
          <li>ä½æ¯å¦ææ ¸å¿æ¸å¤èµ·ä¾ï¼Directory æè®å¾å¾å¤§ï¼æä»¥ææä¸äºæ©å¶ä¾æ¸å° Directory çå¤§å°ï¼ä¾å¦: Groupï¼æä¸äº Core åçµï¼
éæ¨£å°±ä¸ç¨ç´éææç Coreï¼éç¥ Group å°±å¯ä»¥äº</li>
        </ul>
      </li>
      <li>ç®åéå¸¸æä½¿ç¨ Snooping + Directory çåæ³</li>
    </ul>
  </li>
</ul>

<p>å° OS ä¾èªªéäºæ¹æ³ä¸éè¦ï¼éé»æ¯ CPU ä¿è­ææç Core <strong>æçµ</strong>çå°çè³æé½æ¯ä¸è´çã</p>

<blockquote class="block-danger">
  <p>å¦æè¦ä¿è­ææç Core å¨ LLC çå°çè³æé½æ¯ä¸è´çï¼ä»çææ¬æå¾é«ï¼å æ­¤ç¾å¨è¨±å¤ç CPU ååä¿è­ãé¨åæä»¤ãå°æ¼è¨æ¶é«ç³»çµ±çå­åæ¯ Atomic operation</p>
</blockquote>

<h5 id="516-dma-with-cache-coherence">5.16 DMA with Cache Coherence</h5>

<blockquote>
  <p>è½å¤ å»ä¿®æ¹è¨æ¶é«çè£ç½®æ CPU éæå¨éç Deviceï¼ä¾å¦: NIC, GPU</p>
</blockquote>

<p>ä¹åè«ç Cache coherence é½æ¯éå° CPUï¼ä½æ¯å¯¦éä¸æå»ä¿®æ¹ Memory çè£ç½®é½æè©²è¦å»èæ®åæ­¥çåé¡ï¼å çº DMA éå¸¸æ¯è¼æ¢çåå ï¼
å æ­¤è¦ç¢ºä¿ DMA æ¬ç§»å° Memory å¾ï¼CPU ä¹è½çå°ææ°çè³æï¼æè»ç¡¬é«çæ¹å¼å¯ä»¥ä¾åå°ãå çºæ¯ OS çèª²ç¨ï¼æä»¥éè£¡è¦è¨è«çæ¯å°æ¼æåå¯«<strong>ç¨å¼ææä»éº¼å½±é¿</strong>ã</p>

<ul>
  <li>ä»¥è»é«çæ¹å¼ä¾åçè©±
    <ul>
      <li>Linux ä¸­ CPU æè³æå¯«å¥å° DMA ææ¬ç§»çè³ææï¼æè® Cache çè³æ flush å° DRAMï¼ç¢ºä¿ Device æ¿å°çè³ææ¯ææ°ç</li>
      <li>DMA å¯«å¥ DRAM å¾ï¼CPU è¦åéç­è³æææå»æ Cache çè³ææ¸é¤ï¼ä¸¦ä¸éæ°å¾ DRAM è®åï¼ç¢ºä¿ CPU æ¿å°çè³ææ¯ææ°ç</li>
    </ul>
  </li>
  <li>ä»¥ç¡¬é«ä¾èªªï¼è¦å¯«å¥æå¯ä»¥å»æ¾å°ææ°è³æçä½ç½®å¨åª
    <ul>
      <li>å¨ DRAM: å°±ç´æ¥å¯«å¥ DRAM æ´æ°è³æ</li>
      <li>å¨ Cache:
        <ol>
          <li>ç¡¬é«å»ä¸»åæ Cache çè³æåæ¶</li>
          <li>ç´æ¥å¯«å¥ Cache</li>
        </ol>
      </li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>å»¶ä¼¸é±è®: <a href="https://www.kernel.org/doc/Documentation/DMA-API-HOWTO.txt">Dynamic DMA mapping Guide</a></p>
</blockquote>

<h5 id="517-cache-coherence-vs-atomic-operation">5.17 Cache coherence vs Atomic operation</h5>

<blockquote class="block-warning">
  <p>å¾ Linux Kernel 5.4 ä¹å¾æ¯æ´ C11 ç atomicï¼å¨ 5.4 ä¹åççæ¬ï¼Linux Kernel æä½¿ç¨èªå·±ç atomic</p>
</blockquote>

<p>éè£¡è¦æåºä¸åçåï¼å¦æå·²ç¶æ cache coherence çæ©å¶ï¼é£çºä»éº¼ééè¦ atomic operation?</p>

<p>åå¦æä»¥ä¸çææ³å¯è½ç¼ç:</p>
<ol>
  <li>å¦ææåç¬éï¼å©å core åæå°ä¸åè®æ¸åäºä¿®æ¹ï¼å¶ä» core æ¯å¦æçå°åæ­¥ä¸­éççæï¼ä¾å¦: alignment
    <ul>
      <li>alignment: å¯è½ä¸æ¬¡ä¿®æ¹è¦æ´æ°å©æ¢ cache lineï¼æ­¤ææå¯è½çå°åªæ´æ°ä¸åççæ</li>
    </ul>
  </li>
  <li>éå¸¸å¤æ ¸å¿çèçå¨ä¸­ï¼ä¸è½ä¿è­ä¸å core ååºä¿®æ¹å¾æä¸ææå³éçå»¶é²
    <ul>
      <li>core1 ä¿®æ¹ Aï¼ä½éæ²å³éå° core2 çæå core2 åä¿®æ¹äº A</li>
      <li>core æ¸éè¶å¤ï¼è³æäº¤æçé »å¯¬å°±è¶æ¯æè½ç¶é ¸</li>
    </ul>
  </li>
  <li>write buffer, read buffer: å¨é²è¡æä½æææ²æå¯è½é æ write, read æ²ææç§é åºå·è¡ï¼ä¾å¦: æ cache miss æä»¥åå·è¡ç write task è¢« context switch
    <ul>
      <li>éè£¡è¦ç½æ¶å°çæ¯ <a href="https://en.wikipedia.org/wiki/Memory_ordering">Memory order</a> çåé¡ï¼å çºå¨ write buffer, read buffer ä¸­æ¯æ²æ cache coherence æ¼ç®æ³çï¼å¿é è¦ç¢ºå®é åºæè½ä¿è­æ­£ç¢ºæ§</li>
      <li>å¦æè¦å´æ ¼å·è¡é åºçè©±ï¼è¦å¨éäºæä½ä¹éæå¥ mfence</li>
    </ul>
  </li>
</ol>

<p>å¯è½çè§£æ±ºæ¹æ³:</p>
<ol>
  <li>è®ææå°è¨æ¶é«çæä½é½æ¯ atomic çï¼æ­¤æå» lock busï¼è®å¶ä» core ç¡æ³å­åè¨æ¶é«ï¼ç´å°éå core å®ææä½
    <ul>
      <li>å¨ä¸åå¯¦éçéç®ä¸­å¯è½æ¯ 3-4 åæä»¤å°±ææ load, storeï¼éæ¨£çè©±ç­æ¼è¦é »ç¹çå» lock bus ä¸å¤ªç¾å¯¦</li>
    </ul>
  </li>
  <li>é¨åæä»¤å°æ¼ä¸åè¨æ¶é«åéå§æ¯ atomicallyï¼éæ¨£ææ¯è¼å¥½è¨­è¨
    <ul>
      <li>è»é«èç¡¬é«å·¥ç¨å¸«è¨­è¨å¥½åªäºæä»¤å»è§£æ±ºåé¡</li>
    </ul>
  </li>
</ol>

<p><strong>Kaby Lake - Microarchitecture Intel</strong></p>

<p><img src="/image/2023/11-09-synchronization/13.png" alt="" height="100%" width="100%" /></p>

<p><strong>Load buffer &amp; Store buffer in x86</strong></p>

<p><img src="/image/2023/11-09-synchronization/14.png" alt="" height="100%" width="100%" /></p>

<h5 id="518-atomic-operation">5.18 Atomic operation</h5>

<p>å çºæ³è¦ä½¿ææç load, store é½æ¯ atomic å¯¦å¨å¤ªé£è¨­è¨ï¼å æ­¤åªä¿è­é¨åæä»¤æ¯ atomic</p>
<ul>
  <li>å³çµ±ä¸ææ test_n_set, swap éæ¨£ç Assembly
    <ul>
      <li>test_n_set: åå³èçå¼ï¼ä¸¦ä¸ææ°çå¼å¯«å¥ï¼swap: äº¤æå©åå¼</li>
      <li>éå©åç¨å¼ç¸ç¶æ¼ä»¥ä¸ c ç¨å¼ï¼register ç¸ç¶æ¼ CPU å§é¨çå¯¦çæ«å­å¨</li>
    </ul>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">test_n_set</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">register</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>     <span class="cm">/* Update memory */</span>
    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">swap</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">register</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
    <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>        <span class="cm">/* Update memory */</span>
    <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>       <span class="cm">/* Update memory */</span>
<span class="p">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">while(test_n_set(&amp;lock))</code>
    <ul>
      <li>ä¸åç°¡å®ç spinlock éæ¨£å¯¦ä½ï¼ä½æ¯ä»æä¸æ·å»æ´æ° valueï¼è§¸ç¼ cache coherence</li>
      <li>å¦å¤éå©åæä»¤é½æ¯ read-modify-writeï¼æè® cache coherence è®å¾æ²ææç</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">bool atomic_compare_exchange_strong (volatile atomic_int* obj, int* expected, int desired )</code> æ¯æ¹é²çæ¹å¼
    <ul>
      <li>å¦æ obj ç­æ¼ expectedï¼é£éº¼å°±ææ´æ° obj ä¸¦ä¸åå³ true</li>
      <li>å¦æ obj ä¸ç­æ¼ expectedï¼é£éº¼å°±ææ obj çå¼æ´æ°å° expectedï¼ä¸¦ä¸åå³ false</li>
    </ul>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bool</span> <span class="nf">atomic_compare_exchange_strong</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">atomic_int</span><span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">expected</span><span class="p">,</span> <span class="kt">int</span> <span class="n">desired</span> <span class="p">);{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="n">expected</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Only obj equals expected to lock and write obj */</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">desired</span><span class="p">;</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* Only read obj */</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<ul>
  <li>éæ¨£çå¯«æ³ä¸æå»ä¸æ·æ´æ° valueï¼å æ­¤ä¹åªæè§¸ç¼ä¸æ¬¡ write é æ cache coherence
    <ul>
      <li>ä½æ¯éè£¡ä¸¦æ²æä¿è­èª°æåç¼ç¾ obj == expectedï¼éé¨åè¦è»é«å»è¨­è¨</li>
    </ul>
  </li>
</ul>

<h5 id="519-atomic-operation-in-c11">5.19 Atomic operation in c11</h5>

<p>c11 æä¾äºä¸åé¡ä¼¼ test_n_set çæ¯æ´ï¼æ obj è desired swapï¼ä¸¦ä¸åå³èçå¼</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">atomic_exchange</span><span class="p">(</span><span class="n">atomict_int</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="kt">int</span> <span class="n">desired</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">register</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
    <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">desired</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åæ¨£ä¹æ <code class="language-plaintext highlighter-rouge">atomic_compare_exchange_n</code>ï¼çæ¯æ´ï¼å°æ¼ strong, weak çå·®å¥:</p>
<ul>
  <li>å¨ x86 å¹³å°ä¸çæåï¼strong, weak æ²æå·®å¥ï¼å çº x86 æä¿è­èª°åç¼ç¾ obj == expected</li>
  <li>strong: ä¿è­ä¸å®ææ´æ° objï¼åªæå¨ obj != expected æææåå³ false</li>
  <li>weak: ä¸ä¿è­ä¸å®ææ´æ° objï¼æå¯è½å çºå¹³å°é æ obj == expected æåå³ false
    <ul>
      <li>æ­¤æå¯ä»¥ä½¿ç¨ while loop ä¾åè£ä½¿ç¨ weakï¼ç´å°æåçºæ­¢</li>
    </ul>
  </li>
</ul>

<blockquote class="block-warning">
  <p>æç¨ä¸å¦æåªéè¦å·è¡ä¸æ¬¡ï¼é£å°±ä½¿ç¨ strongï¼å¦æéè¦éè¤å·è¡ï¼é£å°±ä½¿ç¨ weak</p>
</blockquote>

<p>ä¾å¦èªªä¸å Initialize çæä½ï¼åªéè¦å·è¡ä¸æ¬¡ä¸¦ä¸ä¸æéç½® initialized çº 0ï¼æä»¥åªæä¸å process ææå</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">initialize_once</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">atomic_compare_exchange_strong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">initialized</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expected</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* If this line is executed, the process is the first to successfully initialize */</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* Resource was already initialized by another process */</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ä¸åç°¡å®çç¯ä¾ï¼å¨æ¼å¦ä½å¯¦ç¾å¤å thread å°æ¼åä¸åè®æ¸å +1 çæä½ï¼<a href="https://gist.github.com/Hotshot824/c2b4d3b073159c91f2a8e3bf11a37271">compare-exchange-spinlock.c</a></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span><span class="o">*</span> <span class="nf">Counter</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">expected</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">counter</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_compare_exchange_weak</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expected</span><span class="p">,</span> <span class="n">expected</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ä¸é¢æå¨æ¯æ¬¡ while ä¹åé½å»åæ expected æ´æ°æ counterï¼ç¶å¾å»æ¯è¼ counter == expectedï¼å¦ææ¯çè©±å°±æ´æ° counterï¼ä¸¦ä¸åå³ trueï¼å¦ååå³ false</p>

<h3 id="spinlock">Spinlock</h3>

<p><a href="./2023-11-09-synchronization.html#520-spinlock-concept-and-advanced">5.20 Spinlock Concept and Advanced</a></p>

<h5 id="520-spinlock-concept-and-advanced">5.20 Spinlock Concept and Advanced</h5>

<ul>
  <li>Spinlock çè¨­æå·§:
    <ul>
      <li>ãæª¢æ¥ -&gt; éä½ãéæ¨£çæ¹æ³æ¯ä¸å°çï¼å¨æª¢æ¥åé²å¥ä¹éæå¶ä» task åãæª¢æ¥ãï¼å°è´å¤å task åæé²å¥</li>
    </ul>
  </li>
  <li>ãéä½ -&gt; æª¢æ¥ -&gt; é²å¥ã:
    <ul>
      <li>ãéä½ãçç®çæ¯åè®å¥äººé²ä¸å»ï¼åå»æª¢æ¥è½å¦é²å¥</li>
      <li>å¦ææ¹è®å®ç¼ç¾ä¸è½é²å¥ï¼é£å°±æãéä½ãççææ¹åä¾</li>
    </ul>
  </li>
  <li>ãæª¢æ¥åéä½ãç¨åä¸å atomic operationï¼ä¾å¦:
    <ul>
      <li>swap, test_n_set (æçæå·®)</li>
      <li>compare_exchange_weak, compare_exchange_strong (æ¯è¼å¥½ï¼ä½æçéæ¯ä¸å¥½)</li>
    </ul>
  </li>
</ul>

<h5 id="521-lockfreequeuec">5.21 lockfreeQueue.c</h5>

<p>å¦æä½¿ç¨ Lock-free çæ¹å¼ææ¯ä½¿ç¨ Semaphore å¿«ä¸æ¸åï¼ä½ç¨å¼çè¤éåº¦ä¹ææé«</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">volatile</span> <span class="kt">int</span> <span class="n">in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">put</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">item</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Using to debug, Ensure that the numbers are an increasing sequence */</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">in</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">bufsize</span> <span class="o">==</span> <span class="n">out</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* busy waiting */</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="o">=</span><span class="n">item</span><span class="o">++</span><span class="p">;</span>  <span class="cm">/* put item into buffer */</span>
    <span class="cm">/* A memory fence should be added here to ensure that get() reads the data after item++ */</span>
    <span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="n">in</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">bufsize</span><span class="p">;</span> <span class="cm">/* The next position to put */</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">get</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">tmpItem</span><span class="p">;</span>    <span class="cm">/* temporary variable to store the item */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">in</span> <span class="o">==</span> <span class="n">out</span><span class="p">)</span> <span class="p">;</span>     <span class="cm">/* busy waiting */</span>
    <span class="n">tmpItem</span><span class="o">=</span><span class="n">buffer</span><span class="p">[</span><span class="n">out</span><span class="p">];</span>    <span class="cm">/* get item from buffer */</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">bufsize</span><span class="p">;</span> <span class="cm">/* The next position to get */</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote class="block-warning">
  <h5 id="last-edit">Last Edit</h5>
  <p>12-08-2023 16:03</p>
</blockquote>

</section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
        <div class="normal">
            <section class="normal">
                
                <i class="fa fa-eye"></i>
                <span id="page-hit-tracker"></span>, 
                <i class="fa fa-archive"></i>
                
                OS
                
                
            </section>
        </div>
    </div>
<script async src="https://www2.cs.ccu.edu.tw/~xbs112m/tracker.php"></script>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


<!-- introduce mathjax support -->
<script>
    function fixes_chrome_anchors() {
        let chrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
        if (window.location.hash && chrome) {
            setTimeout(function () {
                var hash = window.location.hash;
                window.location.hash = "";
                window.location.hash = hash;
            }, 300);
        }
    }

    if (document.readyState === "loading") {
        // Loading hasn't finished yet
        document.addEventListener("DOMContentLoaded", fixes_chrome_anchors);
    } else {
        // `DOMContentLoaded` has already fired
        fixes_chrome_anchors();
    }
</script>

<!-- customize line 38-50 swap next previous-->
                    
                        <a href="/jekyll/2023-11-23-based_on_clp_testcases.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Testing | Method-Level Functional Unit Testing">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    

                    
                        <a href="/jekyll/2023-10-28-method_level_function_unit_testing.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Testing | Based on CLP Testcases">
                            <i class="fa fa-angle-right"></i>
                        </a>
                    
                </div>
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "Testing | Based on CLP Testcases",
            "level": "1.2",
            "depth": 1,
            "path": "_posts/2023/2023-11-23-based_on_clp_testcases.md",
            "ref": "_posts/2023/2023-11-23-based_on_clp_testcases.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "expandable-chapter-small2": {
                "articlesExpand": true,
            },
            "fontsettings": {
                "family": "sans",
                "size": 1,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": false,

                "google": false,

                "github": true,
              
                "github_link": "https://github.com",
              

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": false,
              

                "vk": false,

                "weibo": false,

                // "all": ["facebook", "google", "twitter", "weibo", "instapaper", "github", "telegram"]
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            },
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "Home.md",
        },
        "variables": {},
        "title": "Home",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_posts/2023/2023-11-09-synchronization.md",
        "mtime": "2023-11-09 00:00:00 +0000",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2025-09-16 12:46:29 +0000"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
<script src="/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.js"></script>
<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>
<script src="/assets/gitbook/gitbook-plugin-splitter/splitter.js"></script>

<!--
<script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script>
-->

</body>
</html>