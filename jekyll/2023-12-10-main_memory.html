<!DOCTYPE HTML>
<html lang="en" >
    <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="google-site-verification" content="MrJpPCJ8htzZlGpC1wo97QA1_XWns05Ez0LBsW3wj3I" /><title>OS | Main Memory Â· Home</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Build Jekyll site with the GitBook style.
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="Benson Hsu"><link rel="stylesheet" href="/assets/gitbook/style.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/assets/gitbook/gitbook-plugin-splitter/splitter.css">

<link rel="stylesheet" href="/assets/gitbook/rouge/colorful.css">

<link rel="stylesheet" href="/assets/gitbook/custom.css">
<link rel="stylesheet" href="/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/assets/gitbook/images/favicon.ico" type="image/x-icon">




            <link rel="prev" href="/jekyll/2023-12-09-class_level_testing.html" />
        

        
            <link rel="next" href="/jekyll/2023-12-12-mutation_testing.html" />
        
    </head>
    <body>
        <div class="book"><div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
            <li class="chapter" data-level="1.1" data-path="">
            
                <a href="/" onclick="pageScrollToTop(this)">
                    Home
                </a>
            </li>

            <li class="divider"></li>

            
                <!-- <p>pages</p> -->
                
                    

                    

                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2025-09-13-Big_Number_Multiplication.html">
                        
                            <a href="/jekyll/2025-09-13-Big_Number_Multiplication.html" onclick="pageScrollToTop(this)">
                                Algorithm | Big Number Multiplication
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2025-09-12-Binary_Search_Tricks_and_Hacks.html">
                        
                            <a href="/jekyll/2025-09-12-Binary_Search_Tricks_and_Hacks.html" onclick="pageScrollToTop(this)">
                                Algorithm | Binary Search Tricks and Hacks
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2024-10-17-KLEE_symbolic_execution.html">
                        
                            <a href="/jekyll/2024-10-17-KLEE_symbolic_execution.html" onclick="pageScrollToTop(this)">
                                Paper | KLEE: Introducing Symbolic Execution
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2024-07-28-parallel_and_distributed_systems_introduction.html">
                        
                            <a href="/jekyll/2024-07-28-parallel_and_distributed_systems_introduction.html" onclick="pageScrollToTop(this)">
                                PDS | Introduction of Parallel and Distributed Systems
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-06-21-competitive_paging_algorithm.html">
                        
                            <a href="/jekylls/2024-06-21-competitive_paging_algorithm.html" onclick="pageScrollToTop(this)">
                                Algorithm | Competitive Paging Algorithm
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-06-09-arch_user_repository.html">
                        
                            <a href="/jekylls/2024-06-09-arch_user_repository.html" onclick="pageScrollToTop(this)">
                                Note | Arch User Repository
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-04-09-hirschbergs_algorithm.html">
                        
                            <a href="/jekylls/2024-04-09-hirschbergs_algorithm.html" onclick="pageScrollToTop(this)">
                                Algorithm | Hirschberg&#39;s Algorithm
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-03-08-ANTLR_guide.html">
                        
                            <a href="/jekylls/2024-03-08-ANTLR_guide.html" onclick="pageScrollToTop(this)">
                                Compiler | ANTLR Guide
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-03-06-arch_linux_installation.html">
                        
                            <a href="/jekylls/2024-03-06-arch_linux_installation.html" onclick="pageScrollToTop(this)">
                                Note | Arch Linux Installation
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-03-01-maven_multi_module_project.html">
                        
                            <a href="/jekylls/2024-03-01-maven_multi_module_project.html" onclick="pageScrollToTop(this)">
                                Note | Apache Maven Multi-Module Project Guide
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2024-02-03-storage_and_file_system.html">
                        
                            <a href="/jekyll/2024-02-03-storage_and_file_system.html" onclick="pageScrollToTop(this)">
                                OS | Storage and File System
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2024-01-05-debian_btrfs.html">
                        
                            <a href="/jekylls/2024-01-05-debian_btrfs.html" onclick="pageScrollToTop(this)">
                                Note | Using btrfs on Debian
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2023-12-26-code_generation.html">
                        
                            <a href="/jekylls/2023-12-26-code_generation.html" onclick="pageScrollToTop(this)">
                                Compiler | Code Generation (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-12-23-virtual_memory.html">
                        
                            <a href="/jekyll/2023-12-23-virtual_memory.html" onclick="pageScrollToTop(this)">
                                OS | Virtual Memory
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-12-20-system_testing.html">
                        
                            <a href="/jekyll/2023-12-20-system_testing.html" onclick="pageScrollToTop(this)">
                                Testing | System Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-12-12-mutation_testing.html">
                        
                            <a href="/jekyll/2023-12-12-mutation_testing.html" onclick="pageScrollToTop(this)">
                                Testing | Mutation Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/jekyll/2023-12-10-main_memory.html">
                        
                            <a href="/jekyll/2023-12-10-main_memory.html" onclick="pageScrollToTop(this)">
                                OS | Main Memory
                            </a>
                            
                                
                                    <ul><li><a href="#memory-layout" onclick="mobilePageScrollToAnchor(this)" >Memory Layout</a></li><li><a href="#dram-main-functions" onclick="mobilePageScrollToAnchor(this)" >DRAM Main Functions</a></li><li><a href="#memory-paging-hardware" onclick="mobilePageScrollToAnchor(this)" >Memory Paging Hardware</a></li><li><a href="#fragmentation" onclick="mobilePageScrollToAnchor(this)" >Fragmentation</a></li></ul>

                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-12-09-class_level_testing.html">
                        
                            <a href="/jekyll/2023-12-09-class_level_testing.html" onclick="pageScrollToTop(this)">
                                Testing | Class-Level Unit Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2023-11-29-semantic_analysis.html">
                        
                            <a href="/jekylls/2023-11-29-semantic_analysis.html" onclick="pageScrollToTop(this)">
                                Compiler | Semantic Analysis Notes
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-11-28-test_coverage_criteria.html">
                        
                            <a href="/jekyll/2023-11-28-test_coverage_criteria.html" onclick="pageScrollToTop(this)">
                                Note | Test Coverage Criteria
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-11-25-method_level_structural_unit_testing.html">
                        
                            <a href="/jekyll/2023-11-25-method_level_structural_unit_testing.html" onclick="pageScrollToTop(this)">
                                Testing | Method-Level Structural Unit Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-11-24-deadlock.html">
                        
                            <a href="/jekyll/2023-11-24-deadlock.html" onclick="pageScrollToTop(this)">
                                OS | Deadlock
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-11-23-based_on_clp_testcases.html">
                        
                            <a href="/jekyll/2023-11-23-based_on_clp_testcases.html" onclick="pageScrollToTop(this)">
                                Testing | Based on CLP Testcases
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-11-09-synchronization.html">
                        
                            <a href="/jekyll/2023-11-09-synchronization.html" onclick="pageScrollToTop(this)">
                                OS | Synchronization (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-28-method_level_function_unit_testing.html">
                        
                            <a href="/jekyll/2023-10-28-method_level_function_unit_testing.html" onclick="pageScrollToTop(this)">
                                Testing | Method-Level Functional Unit Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2023-10-26-syntax_analysis.html">
                        
                            <a href="/jekylls/2023-10-26-syntax_analysis.html" onclick="pageScrollToTop(this)">
                                Compiler | Syntax Analysis Notes
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-19-cpu_scheduler.html">
                        
                            <a href="/jekyll/2023-10-19-cpu_scheduler.html" onclick="pageScrollToTop(this)">
                                OS | CPU Scheduler
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-18-process_thread.html">
                        
                            <a href="/jekyll/2023-10-18-process_thread.html" onclick="pageScrollToTop(this)">
                                OS | Process and Thread
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-17-container_of.html">
                        
                            <a href="/jekyll/2023-10-17-container_of.html" onclick="pageScrollToTop(this)">
                                Note | Linux Kernel Macro container_of &amp; offsetof
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-10-test_case_generation.html">
                        
                            <a href="/jekyll/2023-10-10-test_case_generation.html" onclick="pageScrollToTop(this)">
                                Testing | Test Case Generation
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-10-09-operating_system_structure.html">
                        
                            <a href="/jekyll/2023-10-09-operating_system_structure.html" onclick="pageScrollToTop(this)">
                                OS | Operating System Structure
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-23-software_testing_introduction.html">
                        
                            <a href="/jekyll/2023-09-23-software_testing_introduction.html" onclick="pageScrollToTop(this)">
                                Testing | Software Testing Introduction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekylls/2023-09-21-lexical_analysis.html">
                        
                            <a href="/jekylls/2023-09-21-lexical_analysis.html" onclick="pageScrollToTop(this)">
                                Compiler | Lexical Analysis Notes
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-20-compiler_introduction.html">
                        
                            <a href="/jekyll/2023-09-20-compiler_introduction.html" onclick="pageScrollToTop(this)">
                                Compiler | Compilers Introduction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-12-operating_system_introduction.html">
                        
                            <a href="/jekyll/2023-09-12-operating_system_introduction.html" onclick="pageScrollToTop(this)">
                                OS | Operating System Introduction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-07-test_case_generation_based_on_constraint_logic_graph.html">
                        
                            <a href="/jekyll/2023-09-07-test_case_generation_based_on_constraint_logic_graph.html" onclick="pageScrollToTop(this)">
                                Paper | Test Case Generation Based on Constraint Logic Graph
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-09-07-Introduction_OCL.html">
                        
                            <a href="/jekyll/2023-09-07-Introduction_OCL.html" onclick="pageScrollToTop(this)">
                                Note | Object Constraint Language Concepts (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-08-06-gdb_introduction.html">
                        
                            <a href="/jekyll/2023-08-06-gdb_introduction.html" onclick="pageScrollToTop(this)">
                                Note | GNU Debugger Quick Notes
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-08-05-linux_kernel_complie.html">
                        
                            <a href="/jekyll/2023-08-05-linux_kernel_complie.html" onclick="pageScrollToTop(this)">
                                OS | Linux Kernel Compilation
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-28-UML_structure_diagrams.html">
                        
                            <a href="/jekyll/2023-07-28-UML_structure_diagrams.html" onclick="pageScrollToTop(this)">
                                Note | UML Structure Diagrams Introduction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-28-UML_behavior_diagrams.html">
                        
                            <a href="/jekyll/2023-07-28-UML_behavior_diagrams.html" onclick="pageScrollToTop(this)">
                                Note | UML Behavior Diagrams Introduction (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-26-unified_modeling_language.html">
                        
                            <a href="/jekyll/2023-07-26-unified_modeling_language.html" onclick="pageScrollToTop(this)">
                                Note | Unified Modeling Language Concepts
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-22-property_based_testing_entropy_guided_backbox_REST_API-_fuzzer.html">
                        
                            <a href="/jekyll/2023-07-22-property_based_testing_entropy_guided_backbox_REST_API-_fuzzer.html" onclick="pageScrollToTop(this)">
                                Paper | BenFuzz: A Property Based Testing and Entropy Guided Blackbox REST API Fuzzer
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-19-MVVM_modeling_methodology_user_interface.html">
                        
                            <a href="/jekyll/2023-07-19-MVVM_modeling_methodology_user_interface.html" onclick="pageScrollToTop(this)">
                                Paper | A MVVM Modeling Methodology for Information Systems User Interface Design
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-18-software_arch_pattern.html">
                        
                            <a href="/jekyll/2023-07-18-software_arch_pattern.html" onclick="pageScrollToTop(this)">
                                Note | Architectural Patterns Compare MVP, MVC, MVVM
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-07-18-automated_gen_test_case_using_UML.html">
                        
                            <a href="/jekyll/2023-07-18-automated_gen_test_case_using_UML.html" onclick="pageScrollToTop(this)">
                                Paper | Automated-generating test case using UML statechart diagrams (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-06-23-Intergrated_environment_sdd.html">
                        
                            <a href="/jekyll/2023-06-23-Intergrated_environment_sdd.html" onclick="pageScrollToTop(this)">
                                Paper | An Integrated Environment for Specification Driven Development (Unfinished)
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-05-28-characteristics_of_bdd.html">
                        
                            <a href="/jekyll/2023-05-28-characteristics_of_bdd.html" onclick="pageScrollToTop(this)">
                                Paper | A Study of the Characteristics of Behaviour Driven Development
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-05-20-analysis_mutation_testing.html">
                        
                            <a href="/jekyll/2023-05-20-analysis_mutation_testing.html" onclick="pageScrollToTop(this)">
                                Paper | An Analysis and Survey of the Development of Mutation Testing
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-04-21-tdd_concepts.html">
                        
                            <a href="/jekyll/2023-04-21-tdd_concepts.html" onclick="pageScrollToTop(this)">
                                Paper | Test-driven development concepts, taxonomy, and future direction
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-04-18-applying_isoiec25010.html">
                        
                            <a href="/jekyll/2023-04-18-applying_isoiec25010.html" onclick="pageScrollToTop(this)">
                                Paper | Applying the ISO/IEC 25010 Quality Models to Software Product
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-04-13-software_standard.html">
                        
                            <a href="/jekyll/2023-04-13-software_standard.html" onclick="pageScrollToTop(this)">
                                Note | Standard - ISO/IEC
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-02-04-algorithm_kmp.html">
                        
                            <a href="/jekyll/2023-02-04-algorithm_kmp.html" onclick="pageScrollToTop(this)">
                                Leetcode | Algorithm - KMP
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2023-01-12-gomoku_ai.html">
                        
                            <a href="/jekyll/2023-01-12-gomoku_ai.html" onclick="pageScrollToTop(this)">
                                Note | Gomoku AI - Game Tree
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2022-11-24-git_commit.html">
                        
                            <a href="/jekyll/2022-11-24-git_commit.html" onclick="pageScrollToTop(this)">
                                Note | Commit Message Format
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2022-11-08-ai_csp.html">
                        
                            <a href="/jekyll/2022-11-08-ai_csp.html" onclick="pageScrollToTop(this)">
                                Note | Constraint Satisfaction Problem
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2022-11-07-network_urat.html">
                        
                            <a href="/jekyll/2022-11-07-network_urat.html" onclick="pageScrollToTop(this)">
                                Note | Basic UART Concept
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/2022-11-05-docker_jekyll.html">
                        
                            <a href="/jekyll/2022-11-05-docker_jekyll.html" onclick="pageScrollToTop(this)">
                                Note | Docker Build Github Pages
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/1970-01-01-virtual_machine_tool.html">
                        
                            <a href="/jekyll/1970-01-01-virtual_machine_tool.html" onclick="pageScrollToTop(this)">
                                Tool | Virtual Machine
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/1970-01-01-linux_config.html">
                        
                            <a href="/jekyll/1970-01-01-linux_config.html" onclick="pageScrollToTop(this)">
                                Tool | Linux Config
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/1970-01-01-leetcode_guide.html">
                        
                            <a href="/jekyll/1970-01-01-leetcode_guide.html" onclick="pageScrollToTop(this)">
                                Leetcode | Master Guide
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/jekyll/1970-01-01-editor_envirmnment.html">
                        
                            <a href="/jekyll/1970-01-01-editor_envirmnment.html" onclick="pageScrollToTop(this)">
                                Tool | Edirot Guide
                            </a>
                            
                                
                            
                        </li>
                    

                    
                        <li class="divider"></li>
                    
                
            
        </ul>
    </nav>
</div>
<div class="book-body">
                <div class="book-header" role="navigation">
                    <!-- Title -->
                    <h1>
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        
                            <a href="." >OS | Main Memory</a>
                        
                    </h1>
                </div>

                <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div class="normal">
            
            
            <section class="normal">December 10, 2023 </section>
            
        </div>
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    
                        <h1 id="/jekyll/main_memory">OS | Main Memory</h1>
                    

                    <blockquote class="block-tip">
  <p>Operating System: Design and Implementation course notes from CCU, lecturer Shiwu-Lo.</p>
</blockquote>

<ul>
  <li>Physical configuration of DRAM on PC
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRAM + BIOS + MMIO</code></li>
    </ul>
  </li>
  <li>Three main functions of DRAM</li>
  <li>Segmentation memory management</li>
  <li>Paging memory management</li>
  <li>Linux memory layout</li>
  <li>External fragmentation</li>
</ul>

<h5 id="x86-start---bios-address">x86 Start - BIOS Address</h5>

<blockquote class="block-tip">
  <p>å¨ä¸å° PC åéæ©å¾å¯ä¸è½è®åçè¨æ¶é«å°±æ¯ BIOS(ROM)ï¼å¿é éé BIOS æè½å®æå¾çº OS çå§å®¹è¼å¥å° DRAM ä¸­</p>
</blockquote>

<ul>
  <li>x86 å¨ååçæåï¼å·è¡çç¬¬ä¸åæä»¤æ¯å¨ <code class="language-plaintext highlighter-rouge">0xFFFFFFF0</code> éåä½å
    <ul>
      <li>å æ­¤ä¸»æ©æ¿ä¸å¿é ä½¿ç¨ Address decoder å° <code class="language-plaintext highlighter-rouge">0xFFFFFFF0</code> å°æå° BIOS ç Entry point</li>
    </ul>
  </li>
  <li>BIOS è¨­å®å®ç¢å¾ï¼æé²å¥ OS ç Entry point
    <ul>
      <li>ä¾å¦: Linux ç <code class="language-plaintext highlighter-rouge">start_kernel</code></li>
    </ul>
  </li>
</ul>

<h5 id="bios-in-memory-usage">BIOS in Memory Usage</h5>

<p>BIOS éç¶ä¸éè¦é»åå°±è½ä¿å­ï¼ä½æ¯éå¸¸éåº¦ææ¯ DRAM æ¢ï¼æä»¥å¤§é¨åç BIOS ææèªå·±è¤è£½å° DRAM ä¸­ï¼
ä¸¦ä¸éç½® data, stack, heap sectionï¼ç¶å¾å¨ DRAM ä¸­å·è¡ã</p>

<blockquote>
  <p>çºä»éº¼ä¸ä½¿ç¨ Flash memoryï¼å çº Flash memory æ¯ Block device è CPU è½è®åçå¿é æ¯ byte addressable</p>
</blockquote>

<hr />

<h3 id="memory-layout">Memory Layout</h3>

<blockquote>
  <p>ä¸åæ¯å¦æè¨æ¶é«åªæ 256MB æ 512MB ç Memory Layoutï¼å¨ 32-bit ç CPU ä¸­ï¼æå¤åªè½ä½¿ç¨ 4G çå®åç©ºé</p>
</blockquote>

<p><img src="/image/2023/12-10-main_memory/1.png" alt="" /></p>

<ul>
  <li>DRAM ä¹å¤çç©ºéå°±æ¯ MMIOï¼éé¨åçç©ºééå¸¸åªè½éé Kernel å­å</li>
  <li>æ³¨æå°ä»æ BIOS æ å°å°æä¸å±¤çä½ç½®ï¼éæ¨£ BIOS å°±ä¸æå»å ç¨ DRAM çå®åç©ºé</li>
</ul>

<blockquote>
  <p>å»¶ä¼¸é±è®: <a href="https://resources.infosecinstitute.com/topics/hacking/system-address-map-initialization-in-x86x64-architecture-part-1-pci-based-systems/#gref">System address map initialization in x86/x64 architecture part 1: PCI-based systems</a></p>
</blockquote>

<p><img src="/image/2023/12-10-main_memory/2.png" alt="" height="75%" width="75%" /></p>

<ul>
  <li>åå¦ä¸å 4G å®åç©ºéçæ©å¨è£ä¸ 4G ç DRAMï¼é£éº¼æ£é¤ PCI çç©ºéå¾ï¼åªæå©ä¸ 3.25G çç©ºéå¯ç¨</li>
  <li>æå¥½çè§£æ±ºæ¹å¼å°±æ¯éå¥ 64-bit çæä»£ï¼ä¸åªè§£æ±ºäº Memory address çåé¡ï¼ä¹è§£æ±ºäºæªæ¡ä¸è½è¶é 2G çåé¡</li>
</ul>

<blockquote>
  <p>å»¶ä¼¸é±è®: <a href="https://www.quora.com/Why-does-my-motherboard-see-only-3-25-GB-out-of-4-GB-RAM-installed-in-my-PC">Why does my motherboard see only 3,25 GB out of 4 GB RAM installed in my PC?</a></p>
</blockquote>

<p><strong>7.1 BIOS - Memory Map</strong></p>

<p>ä½¿ç¨ <code class="language-plaintext highlighter-rouge">dmesg</code> å¯ä»¥çå° Linux å¨ååæç <strong><a href="https://en.wikipedia.org/wiki/E820">BIOS-e820</a> Physical Memory</strong> éç½®ï¼å¯ä»¥çå°å¹¾ååå</p>
<ul>
  <li>usable: å¯ä»¥ä½¿ç¨çè¨æ¶é«</li>
  <li>reserved: ä¿ççµ¦ BIOS ææ¯å¶ä»ç Device ä½¿ç¨</li>
  <li>ACPI data/NVS: éç½®çµ¦ ACPI æ NVS (Non-Volatile Storage)ä½¿ç¨</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>    0.000000] BIOS-provided physical RAM map:
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x0000000000000000-0x000000000009f7ff] usable    <span class="c"># 0.62 MB</span>
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x000000000009f800-0x000000000009ffff] reserved
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x00000000000ca000-0x00000000000cbfff] reserved
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x00000000000dc000-0x00000000000fffff] reserved
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x0000000000100000-0x00000000bfeeffff] usable    <span class="c"># 3069.94 MB</span>
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x00000000bfef0000-0x00000000bfefefff] ACPI data
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x00000000bfeff000-0x00000000bfefffff] ACPI NVS
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x00000000bff00000-0x00000000bfffffff] usable    <span class="c"># 1 MB</span>
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x00000000f0000000-0x00000000f7ffffff] reserved
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x00000000fec00000-0x00000000fec0ffff] reserved
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x00000000fee00000-0x00000000fee00fff] reserved
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x00000000fffe0000-0x00000000ffffffff] reserved
<span class="o">[</span>    0.000000] BIOS-e820: <span class="o">[</span>mem 0x0000000100000000-0x000000023fffffff] usable    <span class="c"># 5120 MB</span>
</code></pre></div></div>

<p>å¯¦éåéçµ¦é»è¦çè¨æ¶é«æ¯ 8192 MBï¼èç¶ç± BIOS åéä»¥å¾çº 8191 MBï¼å¯ä»¥ç¼ç¾éäº usable çå°åå¶å¯¦æ¯ä¸é£çºçï¼
æäºå°æ¹æ å°å° DRAMï¼æäºå°æ¹æ å°å° MMIOãCPU æå»éé Address decoder å° Physical address æ å°å°ä¸åè£ç½®çè¨æ¶é«ã</p>

<ul>
  <li>DMA è DMA32 æ¯ä¿ççµ¦ 16/32-bit ç DMA controller ä½¿ç¨
    <ul>
      <li>Normal å°±æ¯ä»»ä½è½å¤ ä½¿ç¨ 64-bit address çè£ç½®</li>
    </ul>
  </li>
  <li>Movable zone æ¯ç¨ä¾èç Hotplug çè¨æ¶é«ï¼ä¾å¦: USB Keyboard</li>
  <li>unavailable ranges ä»£è¡¨è©²ååçè¨æ¶é«ä¸å¯ä½¿ç¨
    <ul>
      <li>å¯è½å çº BIOS ææ¯å¶ä»çè£ç½®ä½¿ç¨äºéäºè¨æ¶é«</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>    0.014535] Zone ranges:
<span class="o">[</span>    0.014536]   DMA      <span class="o">[</span>mem 0x0000000000001000-0x0000000000ffffff]
<span class="o">[</span>    0.014539]   DMA32    <span class="o">[</span>mem 0x0000000001000000-0x00000000ffffffff]
<span class="o">[</span>    0.014541]   Normal   <span class="o">[</span>mem 0x0000000100000000-0x000000023fffffff]
<span class="o">[</span>    0.014543]   Device   empty
<span class="o">[</span>    0.014545] Movable zone start <span class="k">for </span>each node
<span class="o">[</span>    0.014548] Early memory node ranges
<span class="o">[</span>    0.014548]   node   0: <span class="o">[</span>mem 0x0000000000001000-0x000000000009efff]
<span class="o">[</span>    0.014550]   node   0: <span class="o">[</span>mem 0x0000000000100000-0x00000000bfeeffff]
<span class="o">[</span>    0.014553]   node   0: <span class="o">[</span>mem 0x00000000bff00000-0x00000000bfffffff]
<span class="o">[</span>    0.014554]   node   0: <span class="o">[</span>mem 0x0000000100000000-0x000000023fffffff]
<span class="o">[</span>    0.014558] Initmem setup node 0 <span class="o">[</span>mem 0x0000000000001000-0x000000023fffffff]
<span class="o">[</span>    0.014577] On node 0, zone DMA: 1 pages <span class="k">in </span>unavailable ranges
<span class="o">[</span>    0.014636] On node 0, zone DMA: 97 pages <span class="k">in </span>unavailable ranges
<span class="o">[</span>    0.027855] On node 0, zone DMA32: 16 pages <span class="k">in </span>unavailable ranges
...
<span class="o">[</span>    0.102320] Kernel/User page tables isolation: enabled
</code></pre></div></div>

<blockquote class="block-warning">
  <p><a href="https://en.wikipedia.org/wiki/Kernel_page-table_isolation">Kernel/User page tables isolation</a> æ¯ç¨ä¾é¿å SPECTRE ä¹é¡çæ»æï¼è® Kernel æèªå·±ç Page tableï¼ç¼ºé»æ¯æéä½ System call çæè½</p>
</blockquote>

<blockquote>
  <p>å»¶ä¼¸é±è®: <a href="https://zhuanlan.zhihu.com/p/590013141">å®æ¨¡å¼å¯å¨é¶æ®µï¼ä»biosè·ååå­ä¿¡æ¯</a></p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">cat /proc/iomem</code> å¯ä»¥çå° Physical address çéç½®</p>

<ul>
  <li>èä¹åç <code class="language-plaintext highlighter-rouge">dmesg</code> é¡¯ç¤ºçå§å®¹ç¸å</li>
  <li>ä¸¦ä¸ kernel æéç½®èªå·±ç code, rodata, data, bss section</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00001000-0009f7ff : System RAM      <span class="c"># 0.62 MB</span>
00100000-bfeeffff : System RAM      <span class="c"># 3069.94 MB</span>
bff00000-bfffffff : System RAM      <span class="c"># 1 MB</span>
100000000-23fffffff : System RAM    <span class="c"># 5120 MB</span>
8f400000-90201b41 : Kernel code
90400000-90cd5fff : Kernel rodata
90e00000-91046d3f : Kernel data
916fe000-927fffff : Kernel bss
</code></pre></div></div>

<hr />

<h3 id="dram-main-functions">DRAM Main Functions</h3>

<p><a href="#72-buffercache">7.2 Buffer/Cache</a><br />
<a href="#73-program-layout">7.3 Program Layout</a><br />
<a href="#74-memory-segmentation">7.4 Memory Segmentation</a><br />
<a href="#75-memory-paging">7.5 Memory Paging</a><br />
<a href="#76-fragmentation-problem">7.6 Fragmentation Problem</a></p>

<p>éè£¡åä»ç´¹ DRAM çç¹æ§:</p>
<ul>
  <li>DRAM çç¹æ§æ¯åªè¦ CPU éå§å·¥ä½ï¼DRAM å°±æå¨ééè½
    <ul>
      <li>å³ä½¿ DRAM æå¤åææ§½ï¼OS ææä»åè¦çºä¸é«</li>
    </ul>
  </li>
  <li>DIMM (Dual In-line Memory Module)
    <ul>
      <li>éå¸¸ææ»¿è¨æ¶é«ä»£è¡¨å®¹éè®å¤§ï¼é »å¯¬è®å¤§ï¼ä½ OS ç¡æ³ç¨ç«æ§å¶æ¯åè¨æ¶é«</li>
    </ul>
  </li>
  <li>NUMA (Non-Uniform Memory Access)
    <ul>
      <li>æå¤å CPU çææ³ä¸ï¼æ¯å CPU é½æèªå·±ç DRAMï¼ä½æ¯ CPU ä¹éå¯ä»¥éé QPI äºç¸å­å</li>
      <li>éç¨®ææ³ä¸ OS å¯ä»¥ç¨ç«æ§å¶æ¯å CPU ç DRAMï¼ä¾å¦: éè·¯ç Server çæ¶æ§</li>
    </ul>
  </li>
  <li>è¨æ¶é«ç¡è«å¦ä½é½è¦èé»
    <ul>
      <li>DRAM ä¸ç®¡æ¯è®åæå¯«å¥æå²å­é½éè¦èé»ï¼æä»¥ OS ææ DRAM å¨é¨ç¨å®</li>
      <li>å¦ææä¸ååæ®µæ²æçæ­£çç¨éï¼é£éæ¯è¦èé»ä¿å­éé¨å garbage</li>
    </ul>
  </li>
  <li><strong>è¨æ¶é«çä¸»è¦ç¨é</strong>
    <ul>
      <li>å·è¡ç¨å¼çæåä½¿ç¨</li>
      <li>åç¶ Cache Memory çè§è²ï¼ä¸»è¦æ¯ç¶ä½ HDD, SSD ç Cache</li>
      <li>åç¶ Buffer çè§è²ï¼åèå¨é Device æºéæï¼éè¦ä¿çä¸å¡ Memory è®è£ç½®å¯ä»¥å­åï¼ä¾å¦: DMA</li>
    </ul>
  </li>
</ul>

<h5 id="72-buffercache">7.2 Buffer/Cache</h5>

<p>éè£¡ä½¿ç¨ <code class="language-plaintext highlighter-rouge">top</code> æ¥çè¨æ¶é«ä½¿ç¨ææ³</p>
<ul>
  <li>OS æç¡åæè¨æ¶é«ç¨å®ï¼ä¾å¦: æ¿ä¾ç¶ä½ Cache, Buffer è® I/O æ´å¿«</li>
  <li>é¡ä¼¼ memory cleaner éæ¨£çè»é«ï¼å»éæ¾è¨æ¶é«åèå¯è½å°è´ I/O è®æ¢</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MiB Mem :   7939.9 total,   7495.9 free,    357.6 used,    314.9 buff/cache
MiB Swap:    953.0 total,    953.0 free,      0.0 used.   7582.3 avail Mem
</code></pre></div></div>

<h5 id="73-program-layout">7.3 Program Layout</h5>

<p>éè£¡èªªæ Program å¨è¨æ¶é«ä¸­çéç½®ï¼ä»¥åä»åçç¨ééé¨åå°±ä¸å¤åä»ç´¹äºï¼å¯ä»¥åèä¸åãOS å¨éè£¡çä»»åå°±æ¯å°å·è¡æªå¾å²å­è£ç½®ä¸­è¼å¥å° Memory ä¸­ï¼éç½®å¥½å·è¡çç°å¢ã</p>

<p><img src="/image/2023/12-10-main_memory/3.png" alt="" height="75%" width="75%" /></p>

<blockquote>
  <p>å¦ææ³è§å¯ Kernel ç code, data, bss section å¯ä»¥ä½¿ç¨ <code class="language-plaintext highlighter-rouge">cat /proc/kallsyms</code>ï¼ä½æ¯éè¦ root æ¬é</p>
</blockquote>

<h5 id="74-memory-segmentation">7.4 Memory Segmentation</h5>

<p>è¨æ¶é«çåæ®µæ©å¶(<a href="https://en.wikipedia.org/wiki/Memory_segmentation">Memory Segmentation</a>)æ¯å¾ç´è¦ºä»¥ç¨å¼çåæ®µä½çºç®¡ççå®åº¦ï¼æ¯å seg. é½å°æå°ç¨å¼çä¸åéè¼¯ä¸ç seg.(text, data, bss, heap, stack)ï¼
éå¸¸ seg. æ¯ä¸å¯ä»¥è¢«æåï¼è¦æåçè©±éè¦ç¡¬é«æ¯æ´ï¼æåºå®çæåå¤§å°ã</p>

<blockquote>
  <p>ä¾å¦: x86 ç ds. fs. gs. ä¸å data ç segmentationï¼å¶ä¸­ fs. gs. æ¯é¡å¤ç data seg.</p>
</blockquote>

<p><img src="/image/2023/12-10-main_memory/4.png" alt="" height="75%" width="75%" /></p>

<p>åä¸åç¨å¼ç seg. å¯ä»¥å¨ Physical memory ä¸­ä¸é£çºï¼éæ¨£å¯ä»¥æ´ææççä½¿ç¨è¨æ¶é«ï¼ä½æ¯éæ¨£å°±æå¯è½ç¢ç Fragmentation Problem(ç¢çååé¡)ã</p>

<p><strong>Management of Segmentation</strong></p>

<p>æ¢ç¶æ¯åºæ¼ Segmentation çç®¡çæ©å¶ï¼é£éº¼ä»æä½¿ç¨çå®åæ¹å¼å°±ææ¯åºæ¼ Base + Offset çæ¹å¼(ç¸å°å®å)ã</p>
<ul>
  <li>ä¾å¦éæ¨£çæä»¤: reg<sub>target</sub> = reg<sub>base</sub> + offset
    <ul>
      <li>éå reg<sub>base</sub> æ¯ OS è½å¤ ç®¡çç</li>
    </ul>
  </li>
  <li>ä¾å¦è¨­è¨ä¸å Register å¯ä»¥åå¥æå code, data, stack çéå§ä½ç½®ï¼éæ¨£å°±è½åéå­æ¾éä¸å seg.</li>
</ul>

<blockquote>
  <p>å¨éç¨®æ©å¶ä¸ Context switch çæåé¤äºåæ general register ä»¥å¤ï¼ééè¦åæ base reg. file</p>
</blockquote>

<p>éç¨® base reg. file çè¨­è¨åæéè¦å¼å¥ limit(é·åº¦)ç¨ä¾éå¶å­åçç¯åï¼å¦æå­åé¯èª¤çè¨æ¶é«å°±æè§¸ç¼ Segmentation Faultã
ä»¥ ARM Cortex-M çºä¾ï¼<a href="https://www.keil.com/pack/doc/CMSIS/Core/html/group__mpu8__functions.html#gafe39c2f98058bcac7e7e0501e64e7a9d">MPU_RBAR</a> æ¯ç¨ä¾è¨­å® base addressï¼MPU_RASR æ¯ç¨ä¾è¨­å® limitã</p>

<blockquote>
  <p>MPU: <a href="https://en.wikipedia.org/wiki/Memory_protection_unit">Memory Protection Unit</a></p>
</blockquote>

<blockquote class="block-warning">
  <p>Memory Segmentation çæ©å¶ä¸¦ä¸å¤ªé©åå¨åæçç°å¢ä¸ï¼è¦æ°å¢ç¨å¼ææ¸å°ç¨å¼ï¼å®¹æé æç¢çååé¡ï¼ä½å¨éæçç°å¢ä¸ï¼ä¾å¦: åµå¥å¼ç³»çµ±ï¼å°±å¾é©åä½¿ç¨éç¨®æ©å¶</p>
</blockquote>

<h5 id="75-memory-paging">7.5 Memory Paging</h5>

<blockquote class="block-tip">
  <p>Memory Paging æ¯ç®åä¸»æµçè¨æ¶é«ç®¡çæ©å¶ï¼ç¸è¼æ¼ Memory Segmentationï¼ä»çç®¡çå®ä½æ¯ Pageï¼èä¸æ¯ Seg.</p>
</blockquote>

<ul>
  <li>Page æ¯åºå®å¤§å°çè¨æ¶é«åå¡ï¼éå¸¸æ¯ 4KB</li>
  <li>OS æå®æ¯å Page çç¨éï¼ä¾å¦: code, data, stack, heap
    <ul>
      <li>ä¸ä¸å®æ¯é£çºåéç Page</li>
    </ul>
  </li>
</ul>

<p><strong><a href="https://en.wikipedia.org/wiki/Page_table">Page Table</a></strong></p>

<p>çºäºç¢ºä¿ç¨å¼å¨å·è¡æä¸æå¿½éå¹²æ¾ï¼OS è¦è½å¾è¼é¬çåææ­£å¨å·è¡çç¨å¼ï¼æä»¥ç¡¬é«ä¸ææ¯æ´ Mapping Table çæ©å¶</p>

<ul>
  <li>åå¦ç³»çµ±æå¤æ 48 å Pageï¼é£éº¼éå Table å°±èµ·ç¢¼è¦æ 48 å entry</li>
  <li>è¦è½éå°æ¯å Page è¨­å®ä¸åçæ¬éï¼ä¾å¦: stack(rw-), code(râ), data(rw-)
    <ul>
      <li>å³ä½¿ stack, data æ¯ç¸åæ¬éï¼ä½æ¯ OS æçµ¦ä»åä¸åçåè½ï¼ä¾å¦: stack å¯ä»¥é¨ç¨å¼å¢å å¤§å°</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>ä¸åæ¯ä¸åç¨å¼å¾ CPU ä½¿ç¨ Virtual address å° Physical address çéç¨ï¼å¶ä¸­ OS æéé Mapping Table ä¾åè½æï¼
å¯¦éä¸éæ¨£çè½ææ¯å¨ CPU ä¸­å®æçï¼æ¯å·²ç¶è¨­è¨å¥½çç¡¬é«ç·è·¯</p>
</blockquote>

<p><img src="/image/2023/12-10-main_memory/5.png" alt="" height="100%" width="100%" /></p>

<p>å¯ä»¥çå°è¡¨æ ¼ä¸­ææ Vir. address, Phy. address çå°æï¼èå±¬æ§æ¬éç­ç­ï¼å¦æ Context switch çæåï¼OS åªéè¦åæéå Page Table å°±å¯ä»¥äºã</p>

<ul>
  <li>åæ OS æç¥ééå Page æ¯ä»éº¼é¡åï¼ä¾å¦: stack åå¦ç¢°è§¸å°éçï¼OS å°±æå»å¢å  stack çå¤§å°ã</li>
  <li>å¨èæ¬è¨æ¶é«ä¸ï¼OS ææéäºè³è¨è¨éå¨ Task Control Block(TCB) ä¸­ï¼ä½¿ç¨ RBtree ä¾ç®¡ç</li>
</ul>

<blockquote>
  <p>Linux Kernel ä¸­ä½¿ç¨ mm_struct ä¾æè¿° Task ç Virtual Memory Layout</p>
</blockquote>

<ul>
  <li>ç¸è¼æ¼ Segmentationï¼Paging çåªé»æ¯:
    <ul>
      <li>å¨è¨æ¶é«åéä¸ Paging æ¯è¼æå½æ§ï¼åªè¦æè¶³å¤ ç Page å°±å¯ä»¥</li>
      <li>å¨ Hardware ä¸ä¸¦æ²æ Segmentation çæ¦å¿µï¼æ¯ç± OS ä¾å¯¦ç¾ç</li>
      <li>æ¯ä¸å Page çå¤§å°æ¯åºå®çï¼åéæ¼ç®æ³ææ¯è¼å¥½å¯¦ç¾</li>
    </ul>
  </li>
  <li>ç¼ºé»:
    <ul>
      <li>Page çæ¸éé è¶é Segmentationï¼æä»¥ Page Table æå¾å¤§ï¼å¯è½æé æç¡¬é« Mapping ä¸çæè½è² æ</li>
      <li>å¦æä½¿ç¨ Assembly å¯«ç¨å¼ï¼Paging çç¨å¼ç¢¼ææ¯è¼é£å¯«ï¼é£æ</li>
    </ul>
  </li>
</ul>

<h5 id="76-fragmentation-problem">7.6 Fragmentation Problem</h5>

<blockquote class="block-tip">
  <p>åªè¦æé æ Memory åæåéçææ³ï¼å°±å¿ç¶ææ Fragmentation Problemï¼éæ¯ä¸åç¡æ³é¿åçåé¡</p>
</blockquote>

<ul>
  <li><strong><a href="å¤é¨ç¢ç">External Fragmentation</a></strong>: å¦æä¸å¡è¨æ¶é«ä¸­ç Free space è¶³å¤ ï¼ä½ç¡æ³æ»¿è¶³ç¨å¼çéæ±ï¼éäº Free space å°±æ¯ External Fragmentation</li>
  <li><strong><a href="å§é¨ç¢ç">Internal Fragmentation</a></strong>: å çºéç½®æ¼ç®æ³ï¼æ¬ä¾åªéè¦ X size çè¨æ¶é«ï¼ä½æ¯åéäº X + Y size çè¨æ¶é«ï¼å¶ä¸­ Y size å°±æ¯ Internal Fragmentation
    <ul>
      <li>ä¾å¦: OS åéç©ºéæè¦ºå¾å©ä¸çç©ºéå¤ªå°äºï¼ä¹¾èææ´åç©ºéé½åéçµ¦ç¨å¼ï¼é£å°±æ¯ Internal Fragmentation</li>
    </ul>
  </li>
</ul>

<p>éè£¡æä¸äºè§£æ±º External Fragmentation çæ¹æ³ï¼ä¾å¦:</p>
<ul>
  <li>Memory Compaction(è¨æ¶é«å£ç¸®): æ¬ç§»è¨æ¶é«ä½¿ Free space è®æé£çºçï¼ä½æ¯ææ¬å¾é«</li>
  <li>æ´å¥½çåéæ¼ç®æ³: Best Fit, Worst Fit, First Fit</li>
</ul>

<p><strong>Fragmentation in Paging/Segmentation</strong></p>

<ul>
  <li>å¨ Pagging çææ³ä¸ï¼ç±æ¼æ¯å Page çå¤§å°ä¸è´ï¼ä¸¦ä¸éé Mapping çæ¹å¼ä½¿ç¨ Pageï¼æä»¥ä¸ææ External Fragmentation
    <ul>
      <li>ä½å çºç¨å¼æéè¦çè¨æ¶é«å¤§å°ä¸æåå¥½æ¯ Page çå¤§å°ï¼æä»¥ææ Internal Fragmentation</li>
    </ul>
  </li>
</ul>

<hr />

<h3 id="memory-paging-hardware">Memory Paging Hardware</h3>

<p><a href="#77-mmu-and-mpu">7.7 MMU and MPU</a><br />
<a href="#78-tlb">7.8 TLB</a><br />
<a href="#79-tlb-miss">7.9 TLB Miss</a><br />
<a href="#710-translation-table-structure">7.10 Translation table structure</a><br />
<a href="#711-hardware-handling-of-tlb-miss">7.11 Hardware Handling of TLB Miss</a><br />
<a href="#712-software-handling-of-tlb-miss">7.12 Software Handling of TLB Miss</a></p>

<blockquote class="block-tip">
  <p>éè£¡æä»ç´¹ Mapping Table çåºæ¬å½¢å¼ï¼å³æ¯ TLB(Translation Lookaside Buffer)ï¼å¦æ TLB ä¸å¤ å¤§è¦æéº¼èç</p>
</blockquote>

<h5 id="77-mmu-and-mpu">7.7 MMU and MPU</h5>

<ul>
  <li>MPU(Memory protection unit): å¯ä»¥è¨­å®ææ®µè¨æ¶é«çæ¬éï¼ä¾å¦: code(râ), data(rw-)</li>
  <li>MMU(Memory management unit): é¤äº MPU çåè½ä»¥å¤ï¼éå¯ä»¥éé MMU ä½¿ OS æ´ææçåéè¨æ¶é«çä½¿ç¨</li>
</ul>

<p><strong>MMU management unit</strong></p>

<ul>
  <li>ä»¥ Segment çºæå°ç®¡çå®ä½
    <ul>
      <li>è¼æ©æçé»è¦æä»¥ Segment çºæå°ç®¡çå®ä½</li>
      <li>å¨ Protect ä¸ææ¯è¼ç´è§</li>
      <li>å çº Segment çç¹æ§ï¼æä»¥å°æ¼è¨æ¶é«ç®¡ççå¹«å©ä¸å¤§</li>
    </ul>
  </li>
  <li>ä»¥ Page çºæå°ç®¡çå®ä½
    <ul>
      <li>å¨ Protect ä¸ææ¯è¼è¤éï¼å çºæ¯åç¨å¼é½ææå¾å¤ Page</li>
      <li>ä½å¨ç®¡çä¸å çº Page åºå®å¤§å°ï¼å æ­¤å¯ä»¥æ´ææççç®¡çè¨æ¶é«</li>
      <li>å çº Page å¾å¤ï¼æä»¥éè¦å¾å¤ç Mapping entriesï¼ä¾å¦: 4GB çè¨æ¶é«å°±è¦ 1M å entries(4GB / 4KB)ï¼éææçºç¡¬é«çè² æ</li>
    </ul>
  </li>
</ul>

<p><strong>MMU Architecture</strong></p>

<p>å¯¦éä¸ MMU æå»ºç«å¨ CPU å§é¨ï¼ä¸é¢æ¯ä¸åç°¡å®çæ¶æ§è¡¨ç¤º CPU ä¸­ MMU, Address decoder, DRAM ä¹éçéä¿:</p>

<p><img src="/image/2023/12-10-main_memory/6.png" alt="" height="100%" width="100%" /></p>

<ul>
  <li>L1 Cache è MMU èª°å¨åèª°å¨å¾ï¼åæ±ºæ¼ CPU çè¨­è¨
    <ul>
      <li>è¦æ³¨æçæ¯ L1 Cache å¦æå¨ MMU åé¢ Context switch çæåï¼å°±è¦æ L1 Cache æ¸ç©º</li>
    </ul>
  </li>
</ul>

<p><strong>MMU Function</strong></p>

<blockquote>
  <p>éè£¡ä»ç´¹ä¸ MMU æè©²ææ¯ä»éº¼æ¨£å­ï¼éä¸é¢èçæ¯æ½è±¡ç°¡åçä¾å­</p>
</blockquote>

<p>åå¦æä»¥ä¸ç·¨ç¢¼ reg<sub>target</sub> = reg<sub>base</sub> + offset</p>
<ul>
  <li>Segment æ©å¶ä¸:
    <ul>
      <li>reg<sub>base</sub> å¯è½æ¯ base<sub>code</sub> éæ¨£çç®¡çæ¹å¼ï¼ä»£è¡¨æ¯ code seg. + offset</li>
    </ul>
  </li>
  <li>Paging æ©å¶ä¸:
    <ul>
      <li>reg<sub>base</sub> ä»£è¡¨çæ¯ Page Numberï¼æä»¥æ¯ Page Number + offset</li>
      <li>ä¾å¦: ä¸å 32 bit çç³»çµ±ï¼Page number ææ¯ 20 bitï¼offset ææ¯ 12 bitï¼å æ­¤ offset æå¤åªè½æ¯ 4KBï¼å æ­¤ä¸éè¦ limit çè¨­è¨</li>
    </ul>
  </li>
</ul>

<h5 id="78-tlb">7.8 TLB</h5>

<p>å¶å¯¦ TLB(<a href="https://en.wikipedia.org/wiki/Translation_lookaside_buffer">Translation Lookaside Buffer</a>) å°±æ¯ä¸åå¨ CPU ä¸­çé«é Buffer(SRAM)ï¼æ MMU ç Page Table å­æ¾å¨ TLB ä¸­ï¼å©ç¨éç¨®æ¹å¼å¯ä»¥å éå°åè½æçéåº¦ã</p>

<p><img src="/image/2023/12-10-main_memory/7.png" alt="" height="100%" width="100%" /></p>

<ul>
  <li>p(page number): ç¨å¼å¨ Logical address ä¸­ç Page number</li>
  <li>f(frame number): å¯¦éå¨ Physical address ä¸­ç Page number</li>
  <li>d(displacement, offset): å¨ Page ä¸­ç offset</li>
</ul>

<p>éè£¡ä¾çä¸åå¯¦éçä¾å­ <a href="https://en.wikipedia.org/wiki/Sandy_Bridge">Intel Sandy Bridge</a> ç TLB è¦æ ¼:</p>

<ul>
  <li>Level 1 TLB
    <ul>
      <li>i-TLB: 72 entries, i means instruction</li>
      <li>d-TLB: 100 entries, d means data</li>
    </ul>
  </li>
  <li>Level 2 TLB (å¦æå¨ L1 TLB ä¸­æ²ææ¾å°ï¼å°±æå° L2 TLB ä¸­æ¥æ¾)
    <ul>
      <li>1024 entries</li>
    </ul>
  </li>
</ul>

<p><strong>TLB Size</strong></p>

<p>é£éº¼ä¸å Page çå¤§å°æ¯ 4KBï¼4KB * 1024 = 4MBï¼ä½æ¯ä¸åç¨å¼ä¸å¯è½åªæ 4MB å¤§å°ï¼éè£¡åçå¦ä¸åä¾å­ï¼MIPS R8000-style TLBï¼ä¸å±æ 384 entriesï¼
éæ¨£ä¹æ 384 * 4KB = 1536KBï¼é½æ¯é é å°æ¼å¯¦éç¨å¼éæ±çã</p>

<p>è§£æ±ºæ¹æ³:</p>
<ul>
  <li>Hardware: å¢å  TLB çæ¸éï¼ä½æ¯éæ¨£æå¢å ç¡¬é«ææ¬(CPU è®å¤§ï¼ææ¬è®é«ï¼æå°æéè®é·)</li>
  <li>Dynamic: å¢å åæè¼å¥ TLB çæ¹å¼</li>
</ul>

<blockquote>
  <p>è¦åæè¼å¥ TLB å°±è¦æèéæ¯ææ¨£çè³æçµæ§ï¼åæè¦ç¡¬é«æ¯æ´</p>
</blockquote>

<h5 id="79-tlb-miss">7.9 TLB Miss</h5>

<blockquote>
  <p>TLB æå¤§å°çéå¶ï¼å æ­¤æç¼ç TLB Missï¼ç¶ Miss ç¼çæå°±æéè¦åæè¼å¥ TLB</p>
</blockquote>

<p>å¢å  TLB çå¤§å°:</p>
<ul>
  <li>TLB åºæ¬ä¸æ¯ä¸åå¹³è¡æå°çç¡¬é«
    <ul>
      <li>Page number æåæè TLB ä¸­çæ¸ç¾å°æ¸åå entries åæ¯å°</li>
    </ul>
  </li>
  <li>æ´å TLB æå¢å ç¡¬é«ææ¬ï¼ä¾å¦: é»æ¶é«æ¸éï¼æèéä½ï¼èé»éå¢å </li>
</ul>

<blockquote>
  <p>æ¢ç¶éæ¨£çè©±å¢å  Page size ä¹æ¯ä¸ç¨®æ¹æ³ï¼ä½æ¯å°±æéä½è»é«å¨ç®¡çä¸çå½æ§ï¼ä¾å¦: huge page</p>
</blockquote>

<p><strong>Dynamic Loading TLB entries</strong></p>

<p>ç¶ MMU ç¼ç¾æä¸å Page number å¨ TLB æ¾ä¸å°å°æç entries æï¼è§¸ç¼ TLB Miss å°ç¶ä¸è¦ä½¿ç¨ç TLB è¼å¥ï¼
Main Memory è¶³å¤ æ¾å¥ææç TLB entriesï¼ä½æ¯éé¨åæè©²è¦ç± Hardware ä¾å¯¦ç¾éæ¯ Software ä¾å¯¦ç¾?</p>

<h5 id="710-translation-table-structure">7.10 Translation table structure</h5>

<blockquote class="block-tip">
  <p>éè£¡ä»ç´¹å¦ä½æ TLB ç entries æ¾å° Main Memory ä¸­ï¼ä½¿ç¨ä»éº¼æ¨£ç Data structure ä¾ç®¡ç</p>
</blockquote>

<p>åå¦æåè¦æ TLB ç entries æ¾å° Main Memory ä¸­ï¼é£åè¨­ä»¥ä¸ææ³:</p>
<ol>
  <li>500MB çç¨å¼ï¼éè¦ 500KB çè¨æ¶é«ç©ºéæ¾ Page Table</li>
  <li>700MB çç¨å¼ï¼éè¦ 700KB çè¨æ¶é«ç©ºéæ¾ Page Table</li>
  <li>1500MB çç¨å¼ï¼éè¦ 1500KB çè¨æ¶é«ç©ºéæ¾ Page Table</li>
</ol>

<p>ä»¥ä¸éäºç¨å¼ä¸æ¨£æåæè¼å¥è¨æ¶é«ï¼éæ¨£çè©±ä¹èä¹ä¹ä¹æé æ External Fragmentationï¼éæ¨£å°±åå¶éèè¡äºï¼Paging æ¬ä¾æ¯ç¨ä¾è§£æ±º Fragmentation åé¡çï¼
ä½æ¯çºäºéäºå¤§å°ä¸ä¸ç Page Tableï¼åèé æäº Fragmentation åé¡ã</p>

<p><strong>Hierarchical Paging</strong></p>

<p>éè£¡å°±ä½¿ç¨ä¸ç¨® Hierarchical Paging(éå±¤å¼åé )çæ¹å¼ä¾è§£æ±ºéååé¡ï¼ä¸å 4KB å¤§å°ç Page å¯ä»¥ç®¡ç 1024 entriesï¼ç¬¬äºå±¤ä¹æ¯ä»¥ 4KB éåå±¤ç®¡çï¼
éæ¨£å©å±¤å°±è½æ¾å¥ 1024 * 1024 = 1M å entriesï¼éæ¨£å°±è½è§£æ±ºä¸é¢çåé¡ã</p>

<p><img src="/image/2023/12-10-main_memory/8.png" alt="" height="100%" width="100%" /></p>

<p>éæ¨£çè©±å®åçæ ¼å¼å°±ææ¹æä»¥ä¸çæ ¼å¼:</p>

<p><img src="/image/2023/12-10-main_memory/9.png" alt="" height="100%" width="100%" /></p>

<ul>
  <li>LV1 PTE(Level 1 Page Table Entry): ç¬¬ä¸å±¤ç Page Table Index</li>
  <li>LV2 PTE(Level 2 Page Table Entry): ç¬¬äºå±¤ç Page Table Index</li>
  <li>d(displacement, offset): å¨ Page ä¸­ç offset</li>
</ul>

<p>æ³¨æå°éæ¨£çæä»¤æ ¼å¼åå¥½æ¯ 2<sup>10</sup> x 2<sup>10</sup> x 2<sup>12</sup> = 2<sup>32</sup>ï¼ä¹å°±æ¯ 32-bit ç CPU å¯ä»¥ä½¿ç¨éæ¨£çæä»¤æ ¼å¼ã</p>

<blockquote>
  <p>å¨éè£¡ LV1, LV2 å¨æ²ææ å°åºå»çæåï¼æè¨­å®çº Invalid bit</p>
</blockquote>

<blockquote>
  <p>å»¶ä¼¸é±è®: Andrew S. Tanenbaum, Modern Operating Systems, Chapter 3, 3.3.2 Page Tables ææ´å¤ç¨®é¡ç Page Table çµæ§å¯ä»¥å, <a href="https://pages.cs.wisc.edu/~solomon/cs537-old/last/paging.html">Marvin Solomon CS 537</a></p>
</blockquote>

<h5 id="711-hardware-handling-of-tlb-miss">7.11 Hardware Handling of TLB Miss</h5>

<p>ç®åå¤§é¨åç CPU é½æ¯ç¨ç¡¬é«ä¾èç TLB Missï¼ç¡¬é«æééä¹åæéç Hierarchical Paging çæä»¤æ¹å¼ä¾æ¥æ¾ Page Tableï¼
å¨ Logical address ä¸­æä»¥éèééçæ¹å¼è¨é: <code class="language-plaintext highlighter-rouge">0xpte1, 0xpte2, 0xoffset</code></p>

<p>ä¸åæ¯ä¸åç°¡å®çæ¶æ§è¡¨ç¤ºå¦ä½èç TLB Miss:</p>

<p><img src="/image/2023/12-10-main_memory/10.png" alt="" height="100%" width="100%" /></p>

<ol>
  <li>é¦å CPU æåå» TLB Searchï¼TLB ä¸­æ²æçè©±å°±æè§¸ç¼ TLB Miss</li>
  <li>PTBR æè¨é LV1 Page Table ç Physical addressï¼ä»¥ä¾ CPU æ¾å° LV1 Page Table
    <ul>
      <li>PTBR(Page Table Base Register): å¨ Intel x86 ä¸­æ¯ CR3</li>
    </ul>
  </li>
  <li>æ¾å°ç¬¬äºå±¤ç LV2 Page Tableï¼ç¶å¾å¨ LV2 Page Table ä¸­æ¾å°å°æç Frame number</li>
  <li>å°ä¸å TLB Entry ç½®ææååæ¾å°ç Frame number</li>
  <li>éæ°åå TLB Searchï¼éæ¬¡å°±ææ¾å°å°æç TLB Entry</li>
</ol>

<h5 id="712-software-handling-of-tlb-miss">7.12 Software Handling of TLB Miss</h5>

<p>MIPS èçå¨ä½¿ç¨äº software-managed TLBï¼éç¨®æ¹å¼ææ¯è¼æ¢ï¼ç¶ TLB miss æå°æè§¸ç¼ exceptionï¼ç¶å¾ OS Kernel æå»é²è¡å¾çºèçã</p>

<p>éè£¡ååºä¸é¡åç TLB exception:</p>
<ol>
  <li>TLB Refill: TLB ä¸­æ²æç¸å°æç entry æå°±æç¼ç</li>
  <li>TLB Invalid: Virtual address ä½¿ç¨è¢«è¨­å®çº Invalid ç entry æå°±æç¼ç</li>
  <li>TLB Modified: TLB æå°æç entryï¼ä½æ¯è©² entry çæ¬éä¸ç¬¦å(No dirty bit)æå°±æç¼ç</li>
</ol>

<blockquote class="block-warning">
  <p>MIPS æåç¥ OS TLB Miss çåå èä½ç½®ï¼ä¸¦æ ¹æ CPU æ­£å¨å·è¡åªä¸å task ä¾ä½¿ç¨é©ç¶çæ¼ç®æ³æ¾åºå°æç entry</p>
</blockquote>

<p>è¦æ³¨æè»é«èç TLB Miss æå©ç¨®å¯è½:</p>
<ul>
  <li>Real Error: ä¹å°±æ¯ç¨å¼ç¢¼åºé¯ï¼ä¾å¦: å­åäºä¸è©²å­åçè¨æ¶é«</li>
  <li>TLB Miss: ä¹å°±æ¯ç¨å¼ç¢¼æ²æåºé¯ï¼åªæ¯ TLB ä¸­æ²æå°æç entry</li>
</ul>

<p>OS Kernel å¨éè£¡å¯ä»¥åç¡¬é«ä¸æ¨£å»ä½¿ç¨ <strong>Paged Page Table</strong>(åé åé è¡¨)ï¼æä½¿ç¨ <strong>Hash Table</strong> ä¾ç®¡ç TLB entriesã
ä¸¦ä¸å¨è»é«ä¸ææ¸æ¥æ­£å¨å·è¡åªäº Taskï¼æä»¥å¯ä»¥æåæå±ç¨ç TLB entries è¼å¥å° TLB ä¸­ï¼éæ¨£å°±å¯ä»¥æ¸å° TLB Miss çç¼çã</p>

<ul>
  <li><strong>Advantages:</strong>
    <ul>
      <li>ééè»é«çè©±ï¼å¯ä»¥æ´ææçæå°ï¼çè³ä¿®æ¹æå°æ¼ç®æ³</li>
      <li>å¯ä»¥æåè¼å¥å±ç¨ç TLB entriesï¼æ¸å° TLB Miss çç¼ç</li>
    </ul>
  </li>
  <li><strong>Disadvantages:</strong>
    <ul>
      <li>è¦å»å·è¡ Exception æç½æ¶å° Mode changeï¼ææé¡å¤çææ¬</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>é¨å MIPS ä¹æç¡¬é«æ©å¶ä¾èµ°è¨ª Page Tableï¼é¨å SPARCãPOWER èçå¨åè¨±è»é«ä¾èç TLB Miss</p>
</blockquote>

<blockquote class="block-warning">
  <p>å¡«å¯« TLB çåè½å¿é ç± Kernel ä¾åï¼ç± User space ä¾åçè©±ææå®å¨æ§çåé¡</p>
</blockquote>

<hr />

<h3 id="fragmentation">Fragmentation</h3>

<p><a href="#713-os-memory-allocation-architecture">7.13 OS memory allocation architecture</a><br />
<a href="#714-kernel-management-of-frames">7.14 Kernel Management of Frames</a><br />
<a href="#715-slab-allocation">7.15 Slab Allocation</a><br />
<a href="#716-malloc">7.16 Malloc</a></p>

<p>Linux Kernel å¹¾ä¹ä¸æä¿®æ¹è Kernel space ç¸éç Page Tableï¼å æ­¤ Kernel æç¡å¯è½å°å»ä½¿ç¨å¤§ç Pageï¼ä¾å¦: 1GBï¼
ä¾éä½å°æ¼ TLB entries çä½¿ç¨ï¼å çºå¨ User space ä¸­ Kernel çé¨åæ¯å±ç¨çï¼ä¿®æ¹ Kernel ç Page Table å¯è½æé æé¡å¤ç TLB Missã</p>

<p>User space çé¨åå°±æä½¿ç¨ 4KB ç Pageï¼éè£¡è¦è¨è«çæ¯ malloc æéº¼åéè¨æ¶é«çµ¦ Task ä½¿ç¨ï¼malloc ä¸ææ¯æ¬¡é½åå¥½ç­æ¼ 4KB çåæ¸ï¼
ç¡¬é«ä¸å¯ä»¥è§£æ±ºçæ¯ 4KB Page çºå®ä½ç Fragmentation åé¡ï¼ä½æ¯ç¨å¼èªç±éç½®çå¤§å°åé¡éæ¯éè¦ç±è»é«ä¾è§£æ±ºã</p>

<h5 id="713-os-memory-allocation-architecture">7.13 OS memory allocation architecture</h5>

<blockquote class="block-tip">
  <p>ä¸åå±ç¤ºä¸åä½æ¥­ç³»çµ±çè¨æ¶é«åéæ¶æ§ï¼æéº¼åå§åå°åéè¨æ¶é«çµ¦ Task ä½¿ç¨</p>
</blockquote>

<p><img src="/image/2023/12-10-main_memory/11.png" alt="" height="100%" width="100%" /></p>

<p>å¨éåæ¶æ§ä¹ä¸éè£¡è¦è¨è«çæ¯:</p>
<ol>
  <li>Kernel å¦ä½ç®¡çåé Frame</li>
  <li>Kernel lib ææä¾ <code class="language-plaintext highlighter-rouge">kmalloc()</code> ä¾æä¾çµ¦ Kernel ç Task ä½¿ç¨</li>
  <li><code class="language-plaintext highlighter-rouge">libc</code> å¦ä½å¯¦ç¾ <code class="language-plaintext highlighter-rouge">malloc()</code> ä¾æä¾çµ¦ User space ç Task ä½¿ç¨
    <ul>
      <li>éè£¡éç¶è¨æ¶é«æå°çç®¡çå®ä½æ¯ 4KBï¼ä½æ¯ libc éé syscall ä¾å Kernel ä¸æ¬¡è¦æ±å¤å page
        <ul>
          <li>ä¾å¦: sbrk(), brk(), mmap()</li>
        </ul>
      </li>
      <li>è malloc() æå¨éäº page ä¸­åéè¨æ¶é«çµ¦ Task ä½¿ç¨ï¼ä»¥æ­¤åå°æ´ç´°å¾®çè¨æ¶é«åé</li>
    </ul>
  </li>
</ol>

<h5 id="714-kernel-management-of-frames">7.14 Kernel Management of Frames</h5>

<p>Kernel éé MMU çæ©å¶ï¼å¯ä»¥æè¨æ¶é«é½è¦çº 4KB å¤§å°ç Page(Frame) ä¾ç®¡ç</p>

<ul>
  <li>Kernel å°ææç DRAM é½ Mapping å° Kernel space
    <ul>
      <li>éä»£è¡¨ Kernel å¯ä»¥ç´æ¥å­åææç DRAMï¼å³ä½¿å·²ç¶åéçµ¦ User Task ä½¿ç¨</li>
      <li>å çºè¨æ¶é«å¹¾ä¹æ¯å®å¨äº¤ç± Kernel ä¾ç®¡çï¼æä»¥ Kernel å§é¨å¿é å°å¿å°èçè¨æ¶é«</li>
    </ul>
  </li>
  <li>å æ­¤éæ©ç³»çµ±ååææå»æ¢æ¸¬è¨æ¶é«å¤§å°åçæ³ï¼éè£¡æä½¿ç¨ <a href="https://www.kernel.org/doc/gorman/html/understand/understand022.html">bootmem</a>
    <ul>
      <li>bitmap åªæå¨æåä½¿ç¨ï¼å çºå¨æéº¼åªåæçé½ä¸é«</li>
    </ul>
  </li>
</ul>

<blockquote class="block-warning">
  <p>å»¶ä¼¸é±è®: <a href="https://hackmd.io/@sysprog/linux-memory">Linux æ ¸å¿è¨­è¨: è¨æ¶é«ç®¡ç</a></p>
</blockquote>

<p><strong>Buddy system</strong></p>

<blockquote class="block-tip">
  <p><a href="https://en.wikipedia.org/wiki/Buddy_memory_allocation">buddy system</a> çç®çæ¯æ´å¿«çæå°å°å¯ä»¥åéçè¨æ¶é«ï¼ä¸¦ä¸ç¡éä¿æè¨æ¶é«çé£çºæ§</p>
</blockquote>

<p>åè¨­å¨åéæï¼kernel å·²ç¶ç¥éæä¸å¡ 2M çé£çºè¨æ¶é«å¯ä»¥åéï¼ä¸¦ä¸ task ä¹å¯ä»¥ç¨æé 2M çè¨æ¶é«å°±å¯ä»¥ç´æ¥åéé 2M çµ¦ task ä½¿ç¨ï¼
åæä¿æè¨æ¶é«çé£çºæ§ï¼å¯ä»¥ä½¿ MMU åæ´ææççåªåã</p>

<p><img src="/image/2023/12-10-main_memory/12.png" alt="" height="100%" width="100%" /></p>

<p>å¨ä¸é¢éåä¾å­ä¸­ï¼æååè¨­ kernel å·²ç¶ç¥éæ 32 å frame å¯ä»¥åéï¼èè²çé¨åä»£è¡¨å·²ç¶è¢«ä½¿ç¨ç frame:</p>
<ul>
  <li>åä½µçæ¢ä»¶æ¯ä¾èªç¸åç parent
    <ul>
      <li>æ©è²èé»è²ç frame ä¾èªåä¸å parent Aï¼æä»¥å¯ä»¥åä½µ</li>
      <li>é»è²ç parent æ¯ Aï¼æ£è²ç parent æ¯ Bï¼æä»¥ä¸è½åä½µ</li>
      <li>åªææ©è²èé»è²åä½µå¾ï¼parent è®çº Bï¼æè½èæ£è²åä½µ</li>
    </ul>
  </li>
  <li>å¦ææ Kernel task éè¦ 2 å pageï¼é£éº¼å°±åªåæ 2 å page ç leaf åéçµ¦ä»
    <ul>
      <li>åçå¦æéè¦ 4 å pageï¼å°±åªåæ 4 å page ç leaf åéçµ¦ä»</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>å¨ Linux kernel ä¸­å¯¦ç¾ buddy system çæ¹å¼æ¯éé bitmap ä¾å¯¦ç¾æ¨¹ï¼èä¸æ¯ççä½¿ç¨ä¸åæ¨¹çè³æçµæ§</p>
</blockquote>

<h5 id="715-slab-allocation">7.15 Slab Allocation</h5>

<blockquote class="block-tip">
  <p>Linux kernel ä¸­æè¨±å¤é »ç¹ä½¿ç¨çè³æçµæ§ï¼ä¾å¦: task_struct, file, inode ç­ç­ï¼å¦æç´æ¥ä½¿ç¨ buddy system ä¾åéè¨æ¶é«ï¼
æå¾å®¹æé æ Fragmentationï¼æä»¥ä½¿ç¨ slab ä¾è§£æ±ºéååé¡</p>
</blockquote>

<p>éç¶ buddy system å¯ä»¥æ¯æ¬¡ä»¥ page(4KB) çºå®ä½åéè¨æ¶é«äºï¼ä½æ¯ç³»çµ±å·è¡æçµå¤§é¨åçè³æçµæ§é½æ¯å°çï¼å æ­¤ Linux ä½¿ç¨ slab ä¾è§£æ±ºå°ç©ä»¶çåéã</p>

<ul>
  <li>slab æå»å buddy system è¦æ¸å pageï¼å¨éè£¡æè¢«ç¨±çº cache(kmem_cache, ä¸¦ä¸æ¯æ CPU cache)
    <ul>
      <li>slab æè¿° kmem_cache çå®ç¾©å¨ <code class="language-plaintext highlighter-rouge">mm/slab.h</code></li>
      <li><code class="language-plaintext highlighter-rouge">cat /proc/slabinfo</code> å¯ä»¥çå°ç®åç³»çµ±ä¸­æåªäº cache</li>
    </ul>
  </li>
  <li>slab allocator æ¯ç±å¾å¤åä¸åå¤§å°ç cache çµæï¼éäº cache éå¸¸æ¯çºäºåéç¹å® object çå¤§å°
    <ul>
      <li>ä¾å¦: å¨ Linux kernel ä¸­ task_struct å¤§ç´åªéè¦ 1.7KB å°±å¯ä»¥ä½¿ç¨ä¸å cache ä¾æåéå object</li>
    </ul>
  </li>
</ul>

<p><img src="/image/2023/12-10-main_memory/13.png" alt="" height="100%" width="100%" /></p>

<ul>
  <li>cache ä¸­ä½¿ç¨ä¸ç¨® list ä¾ç®¡ç: full, partial, free</li>
</ul>

<p>å æ­¤ slab æéå°ä»¥ä¸çç®ç:</p>
<ol>
  <li>å¯ä»¥æ¯ buddy system åéæ´å°çè¨æ¶é«</li>
  <li>cache å¸¸ç¨ç object å¯ä»¥è¢«éè¤ä½¿ç¨ï¼ä¸éè¦éæ°åéè¨æ¶é«(allocating, initialising, destroying)</li>
  <li>æéäºå¸¸ç¨ object è L1 æ L2 cache å°é½ï¼å¯ä»¥æ´å¥½çå©ç¨ hardware cache</li>
</ol>

<p>éè£¡å¯ä»¥æ³å slab å°±æ¯æå¸¸ç¨ç object ç¶æçå¥¶ç¶ï¼cache å°±æ¯çå¥¶ç®±ï¼çå¥¶ç¶å¯ä»¥éè¤å»çå¥¶ç®±ä¸­æ¿åæ¾åã</p>

<blockquote>
  <p>å»¶ä¼¸é±è®: <a href="https://www.kernel.org/doc/gorman/html/understand/understand011.html">Chapter 8  Slab Allocator</a>, <a href="https://zhuanlan.zhihu.com/p/358891862">åå­ç®¡ç slab åéå¨</a></p>
</blockquote>

<h5 id="716-malloc">7.16 Malloc</h5>

<p>éå¸¸ç¨å¼é½ææ heapï¼è malloc å¹¾ä¹é½æ¯å¾ heap ä¸­åééç½®çè¨æ¶é«çµ¦ç¨å¼ä½¿ç¨ã</p>

<ul>
  <li>heap æ¯é£çºéç½®çè¨æ¶é«ç©ºéï¼å¤§å°çº page çåæ¸</li>
  <li>malloc éè£¡æä½¿ç¨ä¸äºæ¼ç®æ³ä¾å¾ heap åéè¨æ¶é«çµ¦ç¨å¼ä½¿ç¨
    <ul>
      <li>ä¾å¦: <a href="https://en.wikipedia.org/wiki/C_dynamic_memory_allocation#dlmalloc_and_ptmalloc">ptmalloc</a></li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>å»¶ä¼¸é±è®: <a href="https://goo.gl/ALHVoh">Glibc åå­ç®¡ç</a>, <a href="https://sourceware.org/glibc/wiki/MallocInternals">Overview of Malloc</a></p>
</blockquote>

<blockquote>
  <p>malloc å¯¦ç¾ééæç®ä¹å¾å¦å¤å¯«ä¸ç¯æç« ï¼ééåªè¦ç¥é task ä½¿ç¨ malloc ä¹ä¸æ¯ç´æ¥å kernel ç´¢è¦ page å°±å¯ä»¥äº</p>
</blockquote>

<blockquote class="block-warning">
  <h5 id="last-edit">Last Edit</h5>
  <p>1-26-2024 19:15</p>
</blockquote>

</section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
        <div class="normal">
            <section class="normal">
                
                <i class="fa fa-eye"></i>
                <span id="page-hit-tracker"></span>, 
                <i class="fa fa-archive"></i>
                
                OS
                
                
            </section>
        </div>
    </div>
<script async src="https://www2.cs.ccu.edu.tw/~xbs112m/tracker.php"></script>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->


<!-- introduce mathjax support -->
<script>
    function fixes_chrome_anchors() {
        let chrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
        if (window.location.hash && chrome) {
            setTimeout(function () {
                var hash = window.location.hash;
                window.location.hash = "";
                window.location.hash = hash;
            }, 300);
        }
    }

    if (document.readyState === "loading") {
        // Loading hasn't finished yet
        document.addEventListener("DOMContentLoaded", fixes_chrome_anchors);
    } else {
        // `DOMContentLoaded` has already fired
        fixes_chrome_anchors();
    }
</script>

<!-- customize line 38-50 swap next previous-->
                    
                        <a href="/jekyll/2023-12-12-mutation_testing.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Testing | Class-Level Unit Testing">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    

                    
                        <a href="/jekyll/2023-12-09-class_level_testing.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Testing | Mutation Testing">
                            <i class="fa fa-angle-right"></i>
                        </a>
                    
                </div>
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "Testing | Mutation Testing",
            "level": "1.2",
            "depth": 1,
            "path": "_posts/2023/2023-12-12-mutation_testing.md",
            "ref": "_posts/2023/2023-12-12-mutation_testing.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "expandable-chapter-small2": {
                "articlesExpand": true,
            },
            "fontsettings": {
                "family": "sans",
                "size": 1,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": false,

                "google": false,

                "github": true,
              
                "github_link": "https://github.com",
              

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": false,
              

                "vk": false,

                "weibo": false,

                // "all": ["facebook", "google", "twitter", "weibo", "instapaper", "github", "telegram"]
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            },
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "Home.md",
        },
        "variables": {},
        "title": "Home",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_posts/2023/2023-12-10-main_memory.md",
        "mtime": "2023-12-10 00:00:00 +0000",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2025-09-16 12:46:29 +0000"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="/assets/gitbook/gitbook.js"></script>
<script src="/assets/gitbook/theme.js"></script>

<script src="/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
<script src="/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.js"></script>
<script src="/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>
<script src="/assets/gitbook/gitbook-plugin-splitter/splitter.js"></script>

<!--
<script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script>
-->

</body>
</html>